<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœˆåº¦æ ¸å¿ƒæ•°æ®çœ‹æ¿</title>
    <!-- ä½¿ç”¨æœ¬åœ°Chart.js -->
    <script src="../libs/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #ffffff;
            color: #333;
            line-height: 1.6;
        }

        .navbar {
            background: #ffffff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 600;
            color: #FF6B35;
        }

        .month-selector {
            padding: 10px 15px;
            border: 2px solid #FF6B35;
            border-radius: 8px;
            background: white;
            color: #333;
            font-size: 16px;
            min-width: 150px;
            cursor: pointer;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: linear-gradient(135deg, #FF6B35 0%, #FFA366 100%);
            border-radius: 12px;
            padding: 20px;
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }

        .metric-card .label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .metric-card .value {
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .metric-card .change {
            font-size: 12px;
            margin-top: 8px;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: inline-block;
        }

        /* å˜åŒ–æŒ‡æ ‡æ ·å¼ï¼ˆä¸­å›½é£æ ¼ï¼šçº¢æ¶¨ç»¿è·Œï¼‰ */
        .changes {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .change-item {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.3);
        }

        .change-item.positive {
            background: rgba(255, 235, 238, 0.8);
            color: #d32f2f;  /* çº¢è‰²è¡¨ç¤ºä¸Šæ¶¨ */
        }

        .change-item.negative {
            background: rgba(232, 245, 232, 0.8);
            color: #388e3c;  /* ç»¿è‰²è¡¨ç¤ºä¸‹è·Œ */
        }

        .chart-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #FF6B35;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #FF6B35;
        }

        .chart-container {
            height: 400px;
            position: relative;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
        }

        /* æ—¶é—´èŒƒå›´é€‰æ‹©å™¨ */
        .trends-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .period-selector {
            display: flex;
            gap: 8px;
        }

        .period-btn {
            padding: 6px 16px;
            border: 1px solid #e0e0e0;
            background: white;
            color: #666;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .period-btn:hover,
        .period-btn.active {
            background: #ff7043;
            color: white;
            border-color: #ff7043;
        }

        /* è¶‹åŠ¿å›¾ç½‘æ ¼ */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .chart-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
        }

        .chart-item h5 {
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
            text-align: center;
        }

        /* Bç«¯æ•°æ®å¡ç‰‡ */
        .b2b-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .b2b-metric-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            border: 2px solid #FFA366;
            transition: all 0.3s ease;
        }

        .b2b-metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2);
        }

        .b2b-metric-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .b2b-metric-value {
            font-size: 18px;
            font-weight: 700;
            color: #ff7043;
        }

        /* AIåˆ†ææ ·å¼ */
        .ai-analysis {
            margin-top: 24px;
        }

        .ai-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .refresh-btn {
            padding: 6px 16px;
            border: 1px solid #e0e0e0;
            background: white;
            color: #666;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: #ff7043;
            color: white;
            border-color: #ff7043;
        }

        .ai-content {
            background: white;
            border-radius: 8px;
            padding: 15px;
            min-height: 200px;
        }

        .ai-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .analysis-section h5 {
            color: #ff7043;
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 600;
            padding-bottom: 5px;
            border-bottom: 2px solid #ff7043;
        }

        .analysis-content {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            border-left: 3px solid #ff7043;
        }

        .analysis-text {
            font-size: 12px;
            line-height: 1.6;
            color: #555;
        }

        .analysis-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .analysis-list li {
            margin-bottom: 8px;
            padding-left: 12px;
            font-size: 12px;
            line-height: 1.5;
            color: #555;
            position: relative;
        }

        .analysis-list li::before {
            content: 'â€¢';
            position: absolute;
            left: 0;
            color: #ff7043;
            font-weight: bold;
        }

        .ai-footer {
            display: flex;
            justify-content: flex-end;
            padding: 10px 0 0 0;
        }

        .ai-credit {
            font-size: 11px;
            color: #999;
        }

        .loading {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 40px 20px;
            font-size: 14px;
        }

        /* å°æ©™å­AIåŠ©æ‰‹æ ·å¼ */
        .ai-assistant {
            position: fixed;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1000;
        }

        .ai-assistant-button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 25px rgba(255, 107, 53, 0.25);
            border: 3px solid #ff7043;
            transition: all 0.3s ease;
            position: relative;
        }

        .ai-assistant-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(255, 107, 53, 0.35);
        }

        .ai-assistant-avatar {
            width: 54px;
            height: 54px;
            object-fit: contain;
        }

        .ai-assistant-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(255, 107, 53, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.4);
                opacity: 0;
            }
        }

        /* AIå¯¹è¯æ¡†æ ·å¼ */
        .ai-chat-modal {
            position: fixed;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            width: 380px;
            height: 600px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1001;
            overflow: hidden;
        }

        .ai-chat-modal.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50%) translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(-50%) translateX(0);
            }
        }

        .ai-chat-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .ai-chat-header {
            background: linear-gradient(135deg, #FF6B35, #FFA366);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ai-chat-avatar img {
            width: 40px;
            height: 40px;
            object-fit: contain;
            background: white;
            border-radius: 8px;
            padding: 4px;
        }

        .ai-chat-info h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .ai-chat-info span {
            font-size: 12px;
            opacity: 0.9;
        }

        .ai-chat-close {
            margin-left: auto;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .ai-chat-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .ai-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .ai-message {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .ai-message.user {
            flex-direction: row-reverse;
        }

        .ai-message-avatar img {
            width: 32px;
            height: 32px;
            object-fit: contain;
            background: white;
            border: 1px solid #ff7043;
            border-radius: 6px;
            padding: 2px;
        }

        .user-message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #ff7043;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        .ai-message-content {
            flex: 1;
            max-width: 280px;
        }

        .ai-message.user .ai-message-content {
            text-align: right;
        }

        .ai-message-bubble {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .ai-message.user .ai-message-bubble {
            background: #ff7043;
            color: white;
        }

        .ai-message-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            padding: 0 4px;
        }

        .ai-message.user .ai-message-time {
            text-align: right;
        }

        .ai-chat-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #eee;
        }

        .ai-chat-suggestions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .suggestion-btn {
            background: #f0f0f0;
            border: none;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-btn:hover {
            background: #ff7043;
            color: white;
        }

        .ai-chat-input-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .ai-chat-input-container input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #eee;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .ai-chat-input-container input:focus {
            border-color: #ff7043;
        }

        .ai-chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ff7043;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 12px;
        }

        .ai-chat-send-btn:hover {
            background: #e55a2b;
            transform: scale(1.05);
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #ff7043;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grid-2, .charts-grid, .b2b-grid, .ai-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .period-selector {
                flex-wrap: wrap;
            }
            
            .period-btn {
                font-size: 11px;
                padding: 4px 12px;
            }
            
            /* ç§»åŠ¨ç«¯AIåŠ©æ‰‹è°ƒæ•´ */
            .ai-assistant {
                left: 15px;
                bottom: 80px;
                top: auto;
                transform: none;
            }
            
            .ai-assistant-button {
                width: 60px;
                height: 60px;
            }
            
            .ai-assistant-avatar {
                width: 42px;
                height: 42px;
            }
            
            .ai-chat-modal {
                left: 15px;
                right: 15px;
                top: 50px;
                bottom: 50px;
                width: auto;
                height: auto;
                transform: none;
            }
            
            .ai-chat-modal.show {
                animation: slideInUp 0.3s ease;
            }
            
            @keyframes slideInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo-text">æœˆåº¦æ ¸å¿ƒæ•°æ®çœ‹æ¿</div>
        <select class="month-selector" id="monthSelector">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </select>
    </div>

    <div class="container">
        <!-- æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ -->
        <div class="metrics-grid" id="metricsGrid">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- è¶‹åŠ¿å›¾è¡¨ -->
        <div class="chart-section">
            <div class="trends-header">
                <h3 class="chart-title">è¶‹åŠ¿åˆ†æ</h3>
                <div class="period-selector">
                    <button class="period-btn active" data-months="3">è¿‘3ä¸ªæœˆ</button>
                    <button class="period-btn" data-months="6">è¿‘6ä¸ªæœˆ</button>
                    <button class="period-btn" data-months="12">è¿‘12ä¸ªæœˆ</button>
                </div>
            </div>
            <div class="charts-grid">
                <div class="chart-item">
                    <h5>æœˆæ´»è¶‹åŠ¿</h5>
                    <div class="chart-container">
                        <canvas id="mauChart"></canvas>
                    </div>
                </div>
                <div class="chart-item">
                    <h5>è¥æ”¶è¶‹åŠ¿</h5>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                <div class="chart-item">
                    <h5>ç•™å­˜ç‡è¶‹åŠ¿</h5>
                    <div class="chart-container">
                        <canvas id="retentionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bç«¯æ ¸å¿ƒæ•°æ® -->
        <div class="chart-section">
            <h3 class="chart-title">Bç«¯æ ¸å¿ƒæ•°æ®</h3>
            <div class="b2b-grid" id="b2bMetrics">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- AIæ•°æ®åˆ†æ -->
        <div class="chart-section ai-analysis">
            <div class="ai-header">
                <h3 class="chart-title">ğŸ¤– AIæ•°æ®åˆ†æ</h3>
                <button class="refresh-btn" onclick="generateAIAnalysis()">åˆ·æ–°åˆ†æ</button>
            </div>
            <div class="ai-content" id="aiAnalysis">
                <div class="loading">æ­£åœ¨åˆ†ææ•°æ®...</div>
            </div>
            <div class="ai-footer">
                <span class="ai-credit">ç”± DeepSeek AI æä¾›æŠ€æœ¯æ”¯æŒ</span>
            </div>
        </div>
    </div>

    <!-- å°æ©™å­AIåŠ©æ‰‹ -->
    <div class="ai-assistant">
        <div class="ai-assistant-button" id="aiAssistantBtn">
            <img src="public/å°æ©™å­.png" alt="å°æ©™å­" class="ai-assistant-avatar">
            <div class="ai-assistant-pulse"></div>
        </div>
        
        <div class="ai-chat-modal" id="aiChatModal">
            <div class="ai-chat-container">
                <div class="ai-chat-header">
                    <div class="ai-chat-avatar">
                        <img src="public/å°æ©™å­.png" alt="å°æ©™å­">
                    </div>
                    <div class="ai-chat-info">
                        <h4>å°æ©™å­</h4>
                        <span>AIæ•°æ®åˆ†æåŠ©æ‰‹</span>
                    </div>
                    <button class="ai-chat-close" id="aiChatClose">Ã—</button>
                </div>
                
                <div class="ai-chat-messages" id="aiChatMessages">
                    <!-- å¯¹è¯æ¶ˆæ¯ -->
                </div>
                
                <div class="ai-chat-input-area">
                    <div class="ai-chat-suggestions">
                        <button class="suggestion-btn">åˆ†ææœ¬æœˆæ•°æ®</button>
                        <button class="suggestion-btn">è¥æ”¶å˜åŒ–åŸå› </button>
                        <button class="suggestion-btn">æå‡å»ºè®®</button>
                    </div>
                    <div class="ai-chat-input-container">
                        <input type="text" id="aiChatInput" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...">
                        <button id="aiChatSend" class="ai-chat-send-btn">å‘é€</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        let monthlyData = [];
        let bData = []; // Bç«¯æ•°æ®
        let currentMonth = null;
        let charts = {};

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupAIAssistant(); // åˆå§‹åŒ–AIåŠ©æ‰‹
        });

        // åŠ è½½æ•°æ®
        function loadData() {
            console.log('åŠ è½½æœˆåº¦æ•°æ®...');
            
            if (typeof dashboardData !== 'undefined' && dashboardData['æœˆåº¦æ ¸å¿ƒæ•°æ®']) {
                monthlyData = dashboardData['æœˆåº¦æ ¸å¿ƒæ•°æ®'].map(row => ({
                    å¹´ä»½: row['å¹´ä»½'],
                    æœˆä»½: row['æœˆä»½'],
                    æœˆæ´»: parseInt(row['æœˆæ´»']),
                    æ¬¡æœˆç•™å­˜: parseFloat(row['æ¬¡æœˆç•™å­˜'].replace('%', '')),
                    è¥æ”¶: parseFloat(row['è¥æ”¶']),
                    è®¢å•: parseInt(row['è®¢å•']),
                    ARPU: parseFloat(row['ARPU']),
                    ARPPU: parseFloat(row['ARPPU']),
                    æ·±åº¦è®¿é—®ç‡: parseFloat(row['æ·±åº¦è®¿é—®ç‡'].replace('%', '')),
                    ä½¿ç”¨ç‡: parseFloat(row['ä½¿ç”¨ç‡'].replace('%', '')),
                    å¤§ä¼šå‘˜æ´»è·ƒç‡: parseFloat(row['å¤§ä¼šå‘˜æ´»è·ƒç‡'].replace('%', ''))
                }));
                
                console.log('æœˆåº¦æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', monthlyData.length, 'æ¡');
                
                // åŠ è½½Bç«¯æ•°æ®
                if (dashboardData['Bç«¯æ ¸å¿ƒæ•°æ®']) {
                    bData = dashboardData['Bç«¯æ ¸å¿ƒæ•°æ®'].map(row => ({
                        å¹´ä»½: row['å¹´ä»½'],
                        æœˆä»½: row['æœˆä»½'],
                        ç­¾çº¦é‡‘é¢: row['ç­¾çº¦é‡‘é¢'],
                        å¼€ç¥¨é‡‘é¢: row['å¼€ç¥¨é‡‘é¢'],
                        åˆ°æ¬¾é‡‘é¢: row['åˆ°æ¬¾é‡‘é¢'],
                        è®¢å•æ•°: row['è®¢å•æ•°'],
                        æ–°ç­¾: row['æ–°ç­¾'],
                        ç»­ç­¾: row['ç»­ç­¾']
                    }));
                    console.log('Bç«¯æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', bData.length, 'æ¡');
                }
                
                initializeDashboard();
            } else {
                console.error('æœªæ‰¾åˆ°æœˆåº¦æ ¸å¿ƒæ•°æ®');
                alert('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·è¿è¡Œ"æ›´æ–°æ•°æ®.bat"');
            }
        }

        // åˆå§‹åŒ–çœ‹æ¿
        function initializeDashboard() {
            // ç”Ÿæˆæœˆä»½é€‰æ‹©å™¨
            const selector = document.getElementById('monthSelector');
            monthlyData.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${item.å¹´ä»½}å¹´${item.æœˆä»½}`;
                selector.appendChild(option);
            });
            
            // é»˜è®¤é€‰æ‹©æœ€æ–°æœˆä»½
            currentMonth = monthlyData.length - 1;
            selector.value = currentMonth;
            
            // ç›‘å¬é€‰æ‹©å™¨å˜åŒ–
            selector.addEventListener('change', function() {
                currentMonth = parseInt(this.value);
                updateDashboard();
            });
            
            // è®¾ç½®æ—¶é—´èŒƒå›´é€‰æ‹©å™¨
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    updateCharts();
                });
            });
            
            // åˆå§‹åŒ–æ˜¾ç¤º
            updateDashboard();
        }

        // æ›´æ–°çœ‹æ¿
        function updateDashboard() {
            updateMetrics();
            updateCharts();
            updateB2BMetrics();
            generateAIAnalysis(); // ç”ŸæˆAIåˆ†æ
        }

        // æ›´æ–°æŒ‡æ ‡å¡ç‰‡
        function updateMetrics() {
            const data = monthlyData[currentMonth];
            const prevData = currentMonth > 0 ? monthlyData[currentMonth - 1] : null;
            const yoyData = getYoYData(data);
            
            const metrics = [
                { 
                    label: 'æœˆæ´»ç”¨æˆ·', 
                    value: data.æœˆæ´».toLocaleString(), 
                    wow: prevData ? calculateChange(data.æœˆæ´», prevData.æœˆæ´») : null,
                    yoy: yoyData ? calculateChange(data.æœˆæ´», yoyData.æœˆæ´») : null
                },
                { 
                    label: 'æ¬¡æœˆç•™å­˜ç‡', 
                    value: data.æ¬¡æœˆç•™å­˜ + '%', 
                    wow: prevData ? calculateChangepp(data.æ¬¡æœˆç•™å­˜, prevData.æ¬¡æœˆç•™å­˜) : null,
                    yoy: yoyData ? calculateChangepp(data.æ¬¡æœˆç•™å­˜, yoyData.æ¬¡æœˆç•™å­˜) : null
                },
                { 
                    label: 'è¥æ”¶', 
                    value: (data.è¥æ”¶ / 10000).toFixed(1) + 'ä¸‡', 
                    wow: prevData ? calculateChange(data.è¥æ”¶, prevData.è¥æ”¶) : null,
                    yoy: yoyData ? calculateChange(data.è¥æ”¶, yoyData.è¥æ”¶) : null
                },
                { 
                    label: 'ARPU', 
                    value: data.ARPU.toFixed(2), 
                    wow: prevData ? (data.ARPU - prevData.ARPU).toFixed(2) : null,
                    yoy: yoyData ? (data.ARPU - yoyData.ARPU).toFixed(2) : null
                },
                { 
                    label: 'ä½¿ç”¨ç‡', 
                    value: data.ä½¿ç”¨ç‡ + '%', 
                    wow: prevData ? calculateChangepp(data.ä½¿ç”¨ç‡, prevData.ä½¿ç”¨ç‡) : null,
                    yoy: yoyData ? calculateChangepp(data.ä½¿ç”¨ç‡, yoyData.ä½¿ç”¨ç‡) : null
                },
                { 
                    label: 'å¤§ä¼šå‘˜æ´»è·ƒç‡', 
                    value: data.å¤§ä¼šå‘˜æ´»è·ƒç‡ + '%', 
                    wow: prevData ? calculateChangepp(data.å¤§ä¼šå‘˜æ´»è·ƒç‡, prevData.å¤§ä¼šå‘˜æ´»è·ƒç‡) : null,
                    yoy: yoyData ? calculateChangepp(data.å¤§ä¼šå‘˜æ´»è·ƒç‡, yoyData.å¤§ä¼šå‘˜æ´»è·ƒç‡) : null
                }
            ];
            
            const grid = document.getElementById('metricsGrid');
            grid.innerHTML = metrics.map(m => `
                <div class="metric-card">
                    <div class="label">${m.label}</div>
                    <div class="value">${m.value}</div>
                    <div class="changes">
                        ${m.wow ? `<span class="change-item ${getChangeClass(m.wow)}">ç¯æ¯” ${m.wow}</span>` : ''}
                        ${m.yoy ? `<span class="change-item ${getChangeClass(m.yoy)}">åŒæ¯” ${m.yoy}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // è®¡ç®—å˜åŒ–ç™¾åˆ†æ¯”
        function calculateChange(current, previous) {
            const change = ((current - previous) / previous * 100).toFixed(1);
            return (change >= 0 ? '+' : '') + change + '%';
        }

        // è®¡ç®—ç™¾åˆ†ç‚¹å˜åŒ–ï¼ˆç”¨äºç™¾åˆ†æ¯”æŒ‡æ ‡ï¼‰
        function calculateChangepp(current, previous) {
            const change = (current - previous).toFixed(1);
            return (change >= 0 ? '+' : '') + change + 'pp';
        }

        // è·å–å»å¹´åŒæœˆæ•°æ®
        function getYoYData(currentData) {
            if (!currentData) return null;
            
            // è§£æå¹´ä»½ï¼ˆ25å¹´ -> 25ï¼‰
            const currentYear = parseInt(currentData.å¹´ä»½.replace('å¹´', ''));
            const targetYear = (currentYear - 1) + 'å¹´';
            const targetMonth = currentData.æœˆä»½;
            
            return monthlyData.find(d => 
                d.å¹´ä»½ === targetYear && d.æœˆä»½ === targetMonth
            );
        }

        // è·å–å˜åŒ–æ ·å¼ç±»ï¼ˆä¸­å›½é£æ ¼ï¼šçº¢æ¶¨ç»¿è·Œï¼‰
        function getChangeClass(change) {
            if (change.includes('+')) return 'positive';  // çº¢è‰²
            if (change.includes('-')) return 'negative';  // ç»¿è‰²
            return '';
        }

        // è·å–è¿‡æ»¤åçš„æ•°æ®
        function getFilteredData() {
            const months = parseInt(document.querySelector('.period-btn.active').dataset.months);
            const endIndex = currentMonth + 1;
            const startIndex = Math.max(0, endIndex - months);
            
            return monthlyData.slice(startIndex, endIndex);
        }

        // æ›´æ–°Bç«¯æŒ‡æ ‡
        function updateB2BMetrics() {
            if (!bData || bData.length === 0) {
                document.getElementById('b2bMetrics').innerHTML = '<p style="text-align:center;color:#999;">æš‚æ— Bç«¯æ•°æ®</p>';
                return;
            }
            
            const currentData = monthlyData[currentMonth];
            const currentB2B = bData.find(d => 
                d.å¹´ä»½ === currentData.å¹´ä»½ && d.æœˆä»½ === currentData.æœˆä»½
            );
            
            if (!currentB2B) {
                document.getElementById('b2bMetrics').innerHTML = '<p style="text-align:center;color:#999;">å½“å‰æœˆä»½æš‚æ— Bç«¯æ•°æ®</p>';
                return;
            }
            
            const metrics = [
                { label: 'ç­¾çº¦é‡‘é¢', value: currentB2B.ç­¾çº¦é‡‘é¢ },
                { label: 'å¼€ç¥¨é‡‘é¢', value: currentB2B.å¼€ç¥¨é‡‘é¢ },
                { label: 'åˆ°æ¬¾é‡‘é¢', value: currentB2B.åˆ°æ¬¾é‡‘é¢ },
                { label: 'è®¢å•æ•°', value: currentB2B.è®¢å•æ•° },
                { label: 'æ–°ç­¾', value: currentB2B.æ–°ç­¾ },
                { label: 'ç»­ç­¾', value: currentB2B.ç»­ç­¾ }
            ];
            
            const grid = document.getElementById('b2bMetrics');
            grid.innerHTML = metrics.map(m => `
                <div class="b2b-metric-card">
                    <div class="b2b-metric-label">${m.label}</div>
                    <div class="b2b-metric-value">${m.value}</div>
                </div>
            `).join('');
        }

        // æ›´æ–°å›¾è¡¨
        function updateCharts() {
            updateMAUChart();
            updateRevenueChart();
            updateRetentionChart();
        }

        // æœˆæ´»è¶‹åŠ¿å›¾
        function updateMAUChart() {
            const ctx = document.getElementById('mauChart');
            if (charts.mau) charts.mau.destroy();
            
            const filteredData = getFilteredData();
            
            charts.mau = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: filteredData.map(d => `${d.å¹´ä»½}${d.æœˆä»½}`),
                    datasets: [{
                        label: 'æœˆæ´»ç”¨æˆ·',
                        data: filteredData.map(d => d.æœˆæ´»),
                        borderColor: '#FF6B35',
                        backgroundColor: 'rgba(255, 107, 53, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: getChartOptions('äºº')
            });
        }

        // è¥æ”¶è¶‹åŠ¿å›¾
        function updateRevenueChart() {
            const ctx = document.getElementById('revenueChart');
            if (charts.revenue) charts.revenue.destroy();
            
            const filteredData = getFilteredData();
            
            charts.revenue = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: filteredData.map(d => `${d.å¹´ä»½}${d.æœˆä»½}`),
                    datasets: [{
                        label: 'è¥æ”¶',
                        data: filteredData.map(d => d.è¥æ”¶),
                        backgroundColor: 'rgba(255, 107, 53, 0.8)',
                        borderColor: '#FF6B35',
                        borderWidth: 1
                    }]
                },
                options: getChartOptions('å…ƒ')
            });
        }

        // ç•™å­˜ç‡è¶‹åŠ¿å›¾
        function updateRetentionChart() {
            const ctx = document.getElementById('retentionChart');
            if (charts.retention) charts.retention.destroy();
            
            const filteredData = getFilteredData();
            
            charts.retention = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: filteredData.map(d => `${d.å¹´ä»½}${d.æœˆä»½}`),
                    datasets: [{
                        label: 'æ¬¡æœˆç•™å­˜ç‡',
                        data: filteredData.map(d => d.æ¬¡æœˆç•™å­˜),
                        borderColor: '#FFA366',
                        backgroundColor: 'rgba(255, 163, 102, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    ...getChartOptions('%'),
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }


        // é€šç”¨å›¾è¡¨é…ç½®
        function getChartOptions(unit) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.parsed.y.toLocaleString();
                                if (unit) {
                                    label += unit;
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + (unit || '');
                            }
                        }
                    }
                }
            };
        }

        // å“åº”å¼
        window.addEventListener('resize', function() {
            Object.values(charts).forEach(chart => {
                if (chart) chart.resize();
            });
        });

        // ==================== AIåŠŸèƒ½ ====================
        
        // ç”ŸæˆAIåˆ†æ
        async function generateAIAnalysis() {
            console.log('ç”ŸæˆAIåˆ†æ...');
            if (currentMonth === null) return;
            
            const analysisElement = document.getElementById('aiAnalysis');
            if (!analysisElement) return;
            
            analysisElement.innerHTML = '<div class="loading">æ­£åœ¨åˆ†ææ•°æ®...</div>';
            
            const currentData = monthlyData[currentMonth];
            const prevData = currentMonth > 0 ? monthlyData[currentMonth - 1] : null;
            const yoyData = getYoYData(currentData);
            
            // æ„å»ºåˆ†ææç¤ºè¯
            const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°æ®åˆ†æå¸ˆï¼Œè¯·åŸºäºä»¥ä¸‹æœˆåº¦æ•°æ®è¿›è¡Œåˆ†æï¼š

ã€å½“å‰æ•°æ®ã€‘${currentData.å¹´ä»½}${currentData.æœˆä»½}ï¼š
â€¢ æœˆæ´»ç”¨æˆ·ï¼š${currentData.æœˆæ´».toLocaleString()}äºº
â€¢ è¥æ”¶ï¼š${(currentData.è¥æ”¶ / 10000).toFixed(1)}ä¸‡å…ƒ
â€¢ ARPUï¼š${currentData.ARPU}å…ƒ
â€¢ æ¬¡æœˆç•™å­˜ç‡ï¼š${currentData.æ¬¡æœˆç•™å­˜}%
â€¢ ä½¿ç”¨ç‡ï¼š${currentData.ä½¿ç”¨ç‡}%
â€¢ å¤§ä¼šå‘˜æ´»è·ƒç‡ï¼š${currentData.å¤§ä¼šå‘˜æ´»è·ƒç‡}%

${prevData ? `ã€ç¯æ¯”å˜åŒ–ã€‘vsä¸Šæœˆï¼š
â€¢ æœˆæ´»ï¼š${calculateChange(currentData.æœˆæ´», prevData.æœˆæ´»)}
â€¢ è¥æ”¶ï¼š${calculateChange(currentData.è¥æ”¶, prevData.è¥æ”¶)}
â€¢ ç•™å­˜ç‡ï¼š${calculateChangepp(currentData.æ¬¡æœˆç•™å­˜, prevData.æ¬¡æœˆç•™å­˜)}` : ''}

${yoyData ? `ã€åŒæ¯”å˜åŒ–ã€‘vså»å¹´åŒæœˆï¼š
â€¢ æœˆæ´»ï¼š${calculateChange(currentData.æœˆæ´», yoyData.æœˆæ´»)}
â€¢ è¥æ”¶ï¼š${calculateChange(currentData.è¥æ”¶, yoyData.è¥æ”¶)}` : ''}

è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼åˆ†æï¼ˆæ¯ä¸ªç»´åº¦ç‹¬ç«‹ä¸€æ®µï¼‰ï¼š

1. æ ¸å¿ƒè¡¨ç°
[ç”¨ä¸€æ®µè¯æè¿°æœ¬æœˆæ•´ä½“æ•°æ®è¡¨ç°ï¼Œ50-80å­—]

2. å…³é”®å˜åŒ–
- [ç¬¬ä¸€ä¸ªå…³é”®å˜åŒ–ï¼Œ20-30å­—]
- [ç¬¬äºŒä¸ªå…³é”®å˜åŒ–ï¼Œ20-30å­—]
- [ç¬¬ä¸‰ä¸ªå…³é”®å˜åŒ–ï¼Œ20-30å­—]

3. ç­–ç•¥å»ºè®®
- [ç¬¬ä¸€æ¡å»ºè®®ï¼Œ20-30å­—]
- [ç¬¬äºŒæ¡å»ºè®®ï¼Œ20-30å­—]
- [ç¬¬ä¸‰æ¡å»ºè®®ï¼Œ20-30å­—]

è¦æ±‚ï¼š
- æ¯ä¸ªè¦ç‚¹ç‹¬ç«‹æˆè¡Œï¼Œä»¥"-"å¼€å¤´
- è¯­è¨€ç®€æ´ä¸“ä¸šï¼Œä¸è¦ä½¿ç”¨ã€ã€‘ç¬¦å·
- å…³é”®å˜åŒ–è¦è¯´æ˜å…·ä½“æ•°æ®å’ŒåŸå› 
- ç­–ç•¥å»ºè®®è¦å…·ä½“å¯æ‰§è¡Œ`;

            try {
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer sk-22da5c080db84c23b4a5c8c54e922763',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸“ä¸šçš„æ•°æ®åˆ†æå¸ˆï¼Œæ“…é•¿åˆ†ææœˆåº¦æ•°æ®å¹¶æä¾›æ´å¯Ÿå’Œå»ºè®®ã€‚å›ç­”è¦ç®€æ´ç²¾å‡†ï¼Œæ¯ä¸ªè¦ç‚¹æ§åˆ¶åœ¨30å­—ä»¥å†…ã€‚'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.3,
                        max_tokens: 800,
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    const analysis = data.choices[0].message.content;
                    displayAIAnalysis(analysis, currentData);
                } else {
                    throw new Error('APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸');
                }
                
            } catch (error) {
                console.error('AIåˆ†æå¤±è´¥:', error);
                // ä½¿ç”¨æœ¬åœ°åˆ†æä½œä¸ºåå¤‡
                displayLocalAnalysis(currentData, prevData, yoyData);
            }
        }

        // æ˜¾ç¤ºAIåˆ†æç»“æœ
        function displayAIAnalysis(analysis, currentData) {
            try {
                console.log('AIåŸå§‹å›å¤:', analysis);
                
                // æ›´æ™ºèƒ½çš„è§£ææ–¹å¼
                let sections = {
                    performance: '',
                    changes: [],
                    suggestions: []
                };
                
                // æŒ‰è¡Œåˆ†å‰²
                const lines = analysis.split('\n').map(l => l.trim()).filter(l => l.length > 0);
                
                let currentSection = '';
                
                lines.forEach(line => {
                    // è¯†åˆ«ç« èŠ‚æ ‡é¢˜
                    if (line.includes('æ ¸å¿ƒè¡¨ç°') || line.includes('1.')) {
                        currentSection = 'performance';
                    } else if (line.includes('å…³é”®å˜åŒ–') || line.includes('2.')) {
                        currentSection = 'changes';
                    } else if (line.includes('ç­–ç•¥å»ºè®®') || line.includes('3.')) {
                        currentSection = 'suggestions';
                    } else if (line.length > 5 && !line.match(/^[1-3][\.\ã€]/)) {
                        // æ¸…ç†è¡Œå†…å®¹
                        const cleanLine = line
                            .replace(/^[ã€\[].*?[ã€‘\]]\s*/, '')  // ç§»é™¤ã€ã€‘[]æ ‡è®°
                            .replace(/^[ï¼š:]\s*/, '')  // ç§»é™¤å¼€å¤´çš„å†’å·
                            .replace(/^[-â€¢Â·*]\s*/, '')  // ç§»é™¤åˆ—è¡¨ç¬¦å·
                            .trim();
                        
                        if (cleanLine.length > 5 && cleanLine.length < 100) {
                            if (currentSection === 'performance') {
                                sections.performance += cleanLine + ' ';
                            } else if (currentSection === 'changes') {
                                sections.changes.push(cleanLine);
                            } else if (currentSection === 'suggestions') {
                                sections.suggestions.push(cleanLine);
                            }
                        }
                    }
                });
                
                // æ„å»ºHTML
                const columns = [];
                
                // ç¬¬ä¸€åˆ—ï¼šæ ¸å¿ƒè¡¨ç°
                const performanceText = sections.performance.trim() || 
                    `æœˆæ´»${currentData.æœˆæ´».toLocaleString()}äººï¼Œè¥æ”¶${(currentData.è¥æ”¶ / 10000).toFixed(1)}ä¸‡å…ƒï¼ŒARPU${currentData.ARPU}å…ƒï¼Œç•™å­˜ç‡${currentData.æ¬¡æœˆç•™å­˜}%ï¼Œä½¿ç”¨ç‡${currentData.ä½¿ç”¨ç‡}%ã€‚`;
                
                columns[0] = `
                    <div class="analysis-section">
                        <h5>æ ¸å¿ƒè¡¨ç°</h5>
                        <div class="analysis-content">
                            <div class="analysis-text">${performanceText}</div>
                        </div>
                    </div>
                `;
                
                // ç¬¬äºŒåˆ—ï¼šå…³é”®å˜åŒ–
                if (sections.changes.length > 0) {
                    columns[1] = `
                        <div class="analysis-section">
                            <h5>å…³é”®å˜åŒ–</h5>
                            <div class="analysis-content">
                                <ul class="analysis-list">
                                    ${sections.changes.slice(0, 4).map(c => `<li>${c}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                } else {
                    columns[1] = `
                        <div class="analysis-section">
                            <h5>å…³é”®å˜åŒ–</h5>
                            <div class="analysis-content">
                                <div class="analysis-text">å„é¡¹æ ¸å¿ƒæŒ‡æ ‡ä¿æŒç¨³å®šï¼Œç”¨æˆ·æ´»è·ƒåº¦è‰¯å¥½ï¼Œè¥æ”¶è¡¨ç°å¹³ç¨³ã€‚</div>
                            </div>
                        </div>
                    `;
                }
                
                // ç¬¬ä¸‰åˆ—ï¼šç­–ç•¥å»ºè®®
                if (sections.suggestions.length > 0) {
                    columns[2] = `
                        <div class="analysis-section">
                            <h5>ç­–ç•¥å»ºè®®</h5>
                            <div class="analysis-content">
                                <ul class="analysis-list">
                                    ${sections.suggestions.slice(0, 4).map(s => `<li>${s}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                } else {
                    columns[2] = `
                        <div class="analysis-section">
                            <h5>ç­–ç•¥å»ºè®®</h5>
                            <div class="analysis-content">
                                <ul class="analysis-list">
                                    <li>æŒç»­ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ</li>
                                    <li>å…³æ³¨æ ¸å¿ƒæŒ‡æ ‡å˜åŒ–</li>
                                    <li>æ¢ç´¢æ–°çš„å¢é•¿æœºä¼š</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                // ç”Ÿæˆä¸‰åˆ—å¸ƒå±€
                document.getElementById('aiAnalysis').innerHTML = `
                    <div class="ai-grid">
                        ${columns[0]}
                        ${columns[1]}
                        ${columns[2]}
                    </div>
                `;

            } catch (error) {
                console.error('AIåˆ†ææ ¼å¼åŒ–å¤±è´¥:', error);
                displayLocalAnalysis(currentData, prevData, yoyData);
            }
        }

        // æœ¬åœ°åˆ†æï¼ˆåå¤‡æ–¹æ¡ˆï¼‰
        function displayLocalAnalysis(currentData, prevData, yoyData) {
            const performanceText = `æœˆæ´»${currentData.æœˆæ´».toLocaleString()}äººï¼Œè¥æ”¶${(currentData.è¥æ”¶ / 10000).toFixed(1)}ä¸‡å…ƒï¼ŒARPU${currentData.ARPU}å…ƒï¼Œç•™å­˜ç‡${currentData.æ¬¡æœˆç•™å­˜}%ï¼Œä½¿ç”¨ç‡${currentData.ä½¿ç”¨ç‡}%ã€‚`;
            
            const changes = [];
            if (prevData) {
                const userChange = ((currentData.æœˆæ´» - prevData.æœˆæ´») / prevData.æœˆæ´» * 100).toFixed(1);
                const revenueChange = ((currentData.è¥æ”¶ - prevData.è¥æ”¶) / prevData.è¥æ”¶ * 100).toFixed(1);
                
                if (Math.abs(userChange) >= 5) {
                    changes.push(`æœˆæ´»${userChange > 0 ? 'å¢é•¿' : 'ä¸‹é™'}${Math.abs(userChange)}%`);
                }
                if (Math.abs(revenueChange) >= 10) {
                    changes.push(`è¥æ”¶${revenueChange > 0 ? 'å¢é•¿' : 'ä¸‹é™'}${Math.abs(revenueChange)}%`);
                }
            }
            
            if (changes.length === 0) {
                changes.push('å„é¡¹æŒ‡æ ‡ä¿æŒç¨³å®š');
                changes.push('æ•´ä½“ä¸šåŠ¡è¿è¡Œå¥åº·');
            }
            
            const strategies = [
                'æŒç»­ä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼Œæå‡æ»¡æ„åº¦',
                'å…³æ³¨æ ¸å¿ƒæŒ‡æ ‡å˜åŒ–ï¼ŒåŠæ—¶è°ƒæ•´ç­–ç•¥',
                'æ¢ç´¢æ–°çš„å¢é•¿æœºä¼šï¼Œæ‰©å¤§ç”¨æˆ·è§„æ¨¡'
            ];

            document.getElementById('aiAnalysis').innerHTML = `
                <div class="ai-grid">
                    <div class="analysis-section">
                        <h5>æ ¸å¿ƒè¡¨ç°</h5>
                        <div class="analysis-content">
                            <div class="analysis-text">${performanceText}</div>
                        </div>
                    </div>
                    <div class="analysis-section">
                        <h5>å…³é”®å˜åŒ–</h5>
                        <div class="analysis-content">
                            <ul class="analysis-list">
                                ${changes.map(c => `<li>${c}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    <div class="analysis-section">
                        <h5>ç­–ç•¥å»ºè®®</h5>
                        <div class="analysis-content">
                            <ul class="analysis-list">
                                ${strategies.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== å°æ©™å­AIåŠ©æ‰‹ ====================
        
        // åˆå§‹åŒ–AIåŠ©æ‰‹
        function setupAIAssistant() {
            const aiBtn = document.getElementById('aiAssistantBtn');
            const aiModal = document.getElementById('aiChatModal');
            const aiClose = document.getElementById('aiChatClose');
            const aiInput = document.getElementById('aiChatInput');
            const aiSend = document.getElementById('aiChatSend');
            
            // æ‰“å¼€å¯¹è¯æ¡†
            aiBtn.addEventListener('click', () => {
                aiModal.classList.add('show');
                aiInput.focus();
                // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
                if (document.getElementById('aiChatMessages').children.length === 0) {
                    addMessageToChat('ai', 'æ‚¨å¥½ï¼æˆ‘æ˜¯å°æ©™å­ğŸŠï¼Œæ‚¨çš„AIæ•°æ®åˆ†æåŠ©æ‰‹ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ');
                }
            });
            
            // å…³é—­å¯¹è¯æ¡†
            aiClose.addEventListener('click', () => {
                aiModal.classList.remove('show');
            });
            
            // å‘é€æ¶ˆæ¯
            aiSend.addEventListener('click', sendAIMessage);
            aiInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendAIMessage();
                }
            });
            
            // å¿«æ·é—®é¢˜
            document.querySelectorAll('.suggestion-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    aiInput.value = this.textContent;
                    sendAIMessage();
                });
            });
        }
        
        // å‘é€AIæ¶ˆæ¯
        async function sendAIMessage() {
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            input.value = '';
            addMessageToChat('user', message);
            showTypingIndicator();
            
            try {
                const currentData = monthlyData[currentMonth];
                const prevData = currentMonth > 0 ? monthlyData[currentMonth - 1] : null;
                
                const contextInfo = `å½“å‰é€‰æ‹©ï¼š${currentData.å¹´ä»½}${currentData.æœˆä»½}
â€¢ æœˆæ´»ï¼š${currentData.æœˆæ´».toLocaleString()}äºº
â€¢ è¥æ”¶ï¼š${(currentData.è¥æ”¶ / 10000).toFixed(1)}ä¸‡å…ƒ
â€¢ ARPUï¼š${currentData.ARPU}å…ƒ
â€¢ ç•™å­˜ç‡ï¼š${currentData.æ¬¡æœˆç•™å­˜}%
â€¢ ä½¿ç”¨ç‡ï¼š${currentData.ä½¿ç”¨ç‡}%`;

                const prompt = `ä½ æ˜¯å°æ©™å­ğŸŠï¼Œä¸€ä¸ªå‹å¥½çš„AIæ•°æ®åˆ†æåŠ©æ‰‹ã€‚

ã€å½“å‰æ•°æ®ã€‘
${contextInfo}

ã€ç”¨æˆ·é—®é¢˜ã€‘
${message}

è¯·ç®€æ´å›ç­”ï¼ˆ150å­—ä»¥å†…ï¼‰ï¼Œè¯­æ°”å‹å¥½ä¸“ä¸šï¼Œå¯ä»¥é€‚å½“ä½¿ç”¨emojiã€‚`;

                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer sk-22da5c080db84c23b4a5c8c54e922763',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯å°æ©™å­ğŸŠï¼Œä¸€ä¸ªä¸“ä¸šå‹å¥½çš„æ•°æ®åˆ†æAIåŠ©æ‰‹ã€‚å›ç­”è¦ç®€æ´ä¸“ä¸šï¼Œè¯­æ°”äº²åˆ‡ï¼Œé€‚å½“ä½¿ç”¨emojiã€‚'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 500,
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status}`);
                }
                
                const data = await response.json();
                
                removeTypingIndicator();
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    addMessageToChat('ai', data.choices[0].message.content);
                } else {
                    throw new Error('APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸');
                }
                
            } catch (error) {
                console.error('AIåŠ©æ‰‹è°ƒç”¨å¤±è´¥:', error);
                removeTypingIndicator();
                addMessageToChat('ai', 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æœ‰ç‚¹å¿™ï¼Œè¯·ç¨åå†è¯•ã€‚æ‚¨ä¹Ÿå¯ä»¥æŸ¥çœ‹å³ä¾§çš„AIæ•°æ®åˆ†æé¢æ¿è·å–åˆ†æç»“æœã€‚');
            }
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessageToChat(sender, message) {
            const messagesContainer = document.getElementById('aiChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${sender}`;
            
            const currentTime = new Date().toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="user-message-avatar">æˆ‘</div>
                    <div class="ai-message-content">
                        <div class="ai-message-bubble">${message}</div>
                        <div class="ai-message-time">${currentTime}</div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="ai-message-avatar">
                        <img src="public/å°æ©™å­.png" alt="å°æ©™å­">
                    </div>
                    <div class="ai-message-content">
                        <div class="ai-message-bubble">${message}</div>
                        <div class="ai-message-time">${currentTime}</div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // æ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('aiChatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'ai-message typing';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="ai-message-avatar">
                    <img src="public/å°æ©™å­.png" alt="å°æ©™å­">
                </div>
                <div class="ai-message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
    </script>
</body>
</html>
