# 核心数据看板趋势图修复说明

## 问题描述

周度核心数据看板的趋势图显示错误或为空。

## 问题原因

1. **字段名不匹配**：CSV文件的字段名与代码期望的字段名不一致
   - 活跃用户趋势CSV：`dt`, `uv`
   - 付费用户及营收趋势CSV：`dt`, `付费用户`, `营收`
   - 使用率趋势CSV：`date`, `使用率百分比`

2. **数据格式转换**：代码期望的数据格式：
   ```javascript
   window.dailyActiveUsers = [
       { date: '2026/1/1', uv: 22054 },
       ...
   ]
   
   window.dailyPaidUsers = [
       { date: '2026/1/1', paidUsers: 345, revenue: 29247 },
       ...
   ]
   
   window.dailyUsageRate = [
       { date: '2026/1/1', usageRate: 63.68 },
       ...
   ]
   ```

## 已完成的修复

### 1. 修改数据加载代码

在 `核心数据看板（周度）/index.html` 中，修改了数据加载函数：

```javascript
// 活跃用户趋势
if (dashboardData['活跃用户趋势_utf8']) {
    window.dailyActiveUsers = dashboardData['活跃用户趋势_utf8'].map(row => ({
        date: row['dt'],      // 使用CSV中的dt字段
        uv: parseInt(row['uv'])  // 使用CSV中的uv字段
    }));
}

// 付费用户及营收趋势
if (dashboardData['付费用户及营收趋势_utf8']) {
    window.dailyPaidUsers = dashboardData['付费用户及营收趋势_utf8'].map(row => ({
        date: row['dt'],
        paidUsers: parseInt(row['付费用户']),
        revenue: parseFloat(row['营收'])
    }));
}

// 使用率趋势
if (dashboardData['使用率趋势_utf8']) {
    window.dailyUsageRate = dashboardData['使用率趋势_utf8'].map(row => ({
        date: row['date'],    // 注意：这个CSV使用date而不是dt
        usageRate: parseFloat(row['使用率百分比'])
    }));
}
```

### 2. 处理百分号

周度核心数据中的百分号已正确处理：
```javascript
次周留存率: parseFloat(row['次周留存率'].replace('%', ''))
```

## 测试步骤

1. **运行一键修复**
   ```bash
   一键修复.bat
   ```

2. **测试数据结构**
   - 打开 `测试核心数据看板.html`
   - 点击"测试data.js"
   - 点击"测试数据结构"
   - 检查字段名是否正确

3. **打开看板验证**
   - 点击"打开核心数据看板"
   - 检查趋势图是否正常显示
   - 切换不同周数，确认数据更新

4. **浏览器控制台检查**
   - 按F12打开开发者工具
   - 查看Console标签
   - 应该看到类似信息：
     ```
     活跃用户趋势加载成功，共 56 条
     付费用户及营收趋势加载成功，共 56 条
     使用率趋势加载成功，共 56 条
     ```

## 常见问题

### Q1: 趋势图仍然为空
**检查**：
1. 打开浏览器控制台（F12）
2. 查看是否有错误信息
3. 检查 `window.dailyActiveUsers` 等变量是否有数据
   ```javascript
   console.log(window.dailyActiveUsers);
   console.log(window.dailyPaidUsers);
   console.log(window.dailyUsageRate);
   ```

### Q2: 数据显示但图表异常
**检查**：
1. 日期格式是否正确（应该是 `2026/1/1` 格式）
2. 数值是否为数字类型（不是字符串）
3. 是否有null或undefined值

### Q3: 只有部分趋势图显示
**原因**：可能某个CSV文件的字段名不匹配

**解决**：
1. 检查CSV文件的第一行（字段名）
2. 对比代码中使用的字段名
3. 如果不匹配，修改 `index.html` 中的字段名

## CSV文件字段对照表

| CSV文件 | 字段名 | 代码中使用的字段 |
|---------|--------|------------------|
| 活跃用户趋势_utf8.csv | dt, uv | date, uv |
| 付费用户及营收趋势_utf8.csv | dt, 付费用户, 营收 | date, paidUsers, revenue |
| 使用率趋势_utf8.csv | date, 使用率百分比 | date, usageRate |
| 周度核心数据_utf8.csv | 年份, 周数, 次周留存率(%) | 年份, 周数, 次周留存率(数字) |

## 验证清单

- [ ] 运行 `一键修复.bat`
- [ ] data.js文件已生成
- [ ] 测试页面显示所有数据集
- [ ] 字段名正确匹配
- [ ] 打开看板，趋势图正常显示
- [ ] 切换周数，数据正确更新
- [ ] 浏览器控制台无错误
