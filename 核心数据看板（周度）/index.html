<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘¨åº¦æ•°æ®åˆ†æçœ‹æ¿</title>
    <!-- ä½¿ç”¨å­—èŠ‚è·³åŠ¨CDNï¼Œå›½å†…è®¿é—®æ›´ç¨³å®š -->
    <script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/Chart.js/3.7.1/chart.min.js"></script>
    <script>
        // å¤‡ç”¨CDNåŠ è½½
        window.addEventListener('DOMContentLoaded', function() {
            if (typeof Chart === 'undefined') {
                console.log('ä¸»CDNåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN...');
                var script = document.createElement('script');
                script.src = 'https://cdn.bootcdn.net/ajax/libs/Chart.js/3.9.1/chart.min.js';
                script.crossOrigin = 'anonymous';
                script.onerror = function() {
                    console.log('å¤‡ç”¨CDN1å¤±è´¥ï¼Œå°è¯•ç¬¬ä¸‰ä¸ªCDN...');
                    var script2 = document.createElement('script');
                    script2.src = 'https://unpkg.com/chart.js@3.9.1/dist/chart.min.js';
                    script2.crossOrigin = 'anonymous';
                    script2.onerror = function() {
                        console.error('æ‰€æœ‰CDNåŠ è½½å¤±è´¥ï¼Œå›¾è¡¨åŠŸèƒ½ä¸å¯ç”¨');
                        alert('å›¾è¡¨åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•');
                    };
                    document.head.appendChild(script2);
                };
                document.head.appendChild(script);
            }
        });
    </script>
    <style>
        /* åŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo img {
            height: 40px;
            width: auto;
        }

        .logo-text {
            font-size: 24px;
            font-weight: bold;
            color: #FF6B35;
        }

        .week-dropdown {
            padding: 10px 15px;
            border: 2px solid #FF6B35;
            border-radius: 8px;
            background: white;
            color: #333;
            font-size: 16px;
            min-width: 200px;
            cursor: pointer;
        }

        /* ä¸»è¦å†…å®¹åŒºåŸŸ - å››å®«æ ¼å¸ƒå±€ */
        .main-content {
            height: calc(100vh - 70px);
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 2fr 1fr;
            gap: 15px;
            padding: 15px;
        }

        /* é€šç”¨é¢æ¿æ ·å¼ */
        .panel {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.08);
            overflow: auto;
            border: 1px solid rgba(255, 107, 53, 0.1);
        }

        .panel-title {
            color: #FF6B35;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .panel-title::before {
            content: '';
            width: 3px;
            height: 18px;
            background: #FF6B35;
            margin-right: 10px;
            border-radius: 2px;
        }

        /* å·¦ä¸Šï¼šå‘¨åº¦æ ¸å¿ƒæ•°æ®æŒ‡æ ‡ */
        .core-metrics {
            grid-area: 1 / 1 / 2 / 2;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        .metric-group {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px;
            border-left: 3px solid #FF6B35;
            min-height: 120px;
        }

        .metric-group h4 {
            color: #FF6B35;
            margin-bottom: 10px;
            font-size: 14px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 6px;
        }

        .metric-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #eee;
            text-align: center;
        }

        .metric-item:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }

        .metric-value {
            font-size: 15px;
            font-weight: 700;
            color: #333;
            margin-bottom: 4px;
        }

        .metric-changes {
            display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: center;
        }

        .change-item {
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 3px;
            background: #f1f3f4;
            white-space: nowrap;
        }

        /* ä¸­å›½é£æ ¼é¢œè‰²ï¼šçº¢æ¶¨ç»¿è·Œ */
        .change-item.positive {
            background: #ffebee;
            color: #d32f2f;
        }

        .change-item.negative {
            background: #e8f5e8;
            color: #388e3c;
        }

        /* å·¦ä¸‹ï¼šBç«¯æ ¸å¿ƒæ•°æ®æŒ‡æ ‡ */
        .b2b-metrics {
            grid-area: 2 / 1 / 3 / 2;
        }

        .b2b-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 10px;
        }

        .b2b-metric-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            border: 2px solid #FFA366;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .b2b-metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #FF6B35, #FFA366);
        }

        .b2b-metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.15);
        }

        .b2b-metric-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
        }

        .b2b-metric-value {
            font-size: 15px;
            font-weight: 700;
            color: #FF6B35;
        }

        /* å³ä¸Šï¼šè¶‹åŠ¿åˆ†æ */
        .trends-analysis {
            grid-area: 1 / 2 / 2 / 3;
        }

        .trends-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .period-selector {
            display: flex;
            gap: 5px;
            background: #f8f9fa;
            padding: 3px;
            border-radius: 8px;
        }

        .period-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: #666;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .period-btn:hover,
        .period-btn.active {
            background: #FF6B35;
            color: white;
        }

        .charts-container {
            height: calc(100% - 50px);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .chart-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
        }

        .chart-item h5 {
            color: #333;
            margin-bottom: 8px;
            font-size: 13px;
            text-align: center;
        }

        .chart-item canvas {
            max-height: 110px;
        }

        /* å³ä¸‹ï¼šAIæ•°æ®åˆ†æ */
        .ai-analysis {
            grid-area: 2 / 2 / 3 / 3;
        }

        .ai-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 12px;
        }

        .ai-title {
            color: #FF6B35;
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
        }

        .ai-title::before {
            content: '';
            width: 3px;
            height: 18px;
            background: #FF6B35;
            margin-right: 10px;
            border-radius: 2px;
        }

        .deepseek-badge {
            font-size: 10px;
            color: #666;
            background: #f0f0f0;
            padding: 3px 8px;
            border-radius: 12px;
            border: 1px solid #ddd;
        }

        .ai-content {
            background: white;
            border-radius: 8px;
            padding: 15px;
            height: calc(100% - 80px);
            overflow-y: auto;
        }

        .ai-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            height: 100%;
        }

        .ai-column {
            display: flex;
            flex-direction: column;
        }

        .analysis-section {
            margin-bottom: 15px;
            flex: 1;
        }

        .analysis-section h5 {
            color: #FF6B35;
            margin-bottom: 10px;
            font-size: 13px;
            font-weight: 600;
            padding-bottom: 5px;
            border-bottom: 2px solid #FF6B35;
            position: relative;
        }

        .analysis-content {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            height: calc(100% - 35px);
            border-left: 3px solid #FF6B35;
        }

        .key-metrics-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }

        .metric-display {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .metric-display .label {
            font-size: 9px;
            color: #666;
            margin-bottom: 2px;
        }

        .metric-display .value {
            font-size: 14px;
            font-weight: 700;
            color: #FF6B35;
        }

        .analysis-text {
            font-size: 11px;
            line-height: 1.4;
            color: #555;
        }

        .analysis-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .analysis-list li {
            margin-bottom: 6px;
            padding-left: 12px;
            font-size: 11px;
            line-height: 1.4;
            color: #555;
            position: relative;
        }

        .analysis-list li::before {
            content: 'â€¢';
            position: absolute;
            left: 0;
            color: #FF6B35;
            font-weight: bold;
        }

        .ai-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0 0 0;
        }

        .ai-status {
            display: flex;
            gap: 8px;
        }

        .status-btn {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 10px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .status-btn.active {
            background: #4CAF50;
            color: white;
        }

        .status-btn.refresh {
            background: #f0f0f0;
            color: #666;
            border: 1px solid #ddd;
        }

        .ai-credit {
            font-size: 9px;
            color: #999;
        }

        .loading {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
            font-size: 11px;
            grid-column: 1 / -1;
        }

        /* å°æ©™å­AIåŠ©æ‰‹æ ·å¼ */
        .ai-assistant {
            position: fixed;
            left: 30px;
            top: 60%;
            transform: translateY(-50%);
            z-index: 1000;
        }

        .ai-assistant-button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 25px rgba(255, 107, 53, 0.25);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 3px solid #FF6B35;
            padding: 8px;
        }

        .ai-assistant-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(255, 107, 53, 0.35);
            border-color: #FFA366;
        }

        .ai-assistant-avatar {
            width: 54px;
            height: 54px;
            object-fit: contain;
            /* æ”¹ä¸ºcontainç¡®ä¿å®Œæ•´æ˜¾ç¤ºï¼Œä¸è£å‰ªç»¿å¶ */
        }

        .ai-assistant-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(255, 107, 53, 0.2);
            animation: pulse 2s infinite;
            border: 2px solid #FF6B35;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.4);
                opacity: 0;
            }
        }

        /* AIå¯¹è¯æ¡†æ ·å¼ */
        .ai-chat-modal {
            position: fixed;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            width: 380px;
            height: 600px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1001;
            overflow: hidden;
        }

        .ai-chat-modal.show {
            display: block;
            animation: slideInLeft 0.3s ease;
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateY(-50%) translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(-50%) translateX(0);
            }
        }

        .ai-chat-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .ai-chat-header {
            background: linear-gradient(135deg, #FF6B35, #FFA366);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ai-chat-avatar img {
            width: 40px;
            height: 40px;
            object-fit: contain;
            background: white;
            border: 2px solid #FF6B35;
            border-radius: 8px;
            padding: 2px;
        }

        .ai-chat-info h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .ai-chat-info span {
            font-size: 12px;
            opacity: 0.9;
        }

        .ai-chat-close {
            margin-left: auto;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .ai-chat-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .ai-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .ai-message {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .ai-message.user {
            flex-direction: row-reverse;
        }

        .ai-message-avatar img {
            width: 32px;
            height: 32px;
            object-fit: contain;
            background: white;
            border: 1px solid #FF6B35;
            border-radius: 6px;
            padding: 2px;
        }

        .user-message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #FF6B35;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        .ai-message-content {
            flex: 1;
            max-width: 280px;
        }

        .ai-message.user .ai-message-content {
            text-align: right;
        }

        .ai-message-bubble {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .ai-message.user .ai-message-bubble {
            background: #FF6B35;
            color: white;
        }

        .ai-message-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            padding: 0 4px;
        }

        .ai-message.user .ai-message-time {
            text-align: right;
        }

        .ai-chat-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #eee;
        }

        .ai-chat-suggestions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .suggestion-btn {
            background: #f0f0f0;
            border: none;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-btn:hover {
            background: #FF6B35;
            color: white;
        }

        .ai-chat-input-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .ai-chat-input-container input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #eee;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .ai-chat-input-container input:focus {
            border-color: #FF6B35;
        }

        .ai-chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #FF6B35;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .ai-chat-send-btn:hover {
            background: #e55a2b;
            transform: scale(1.05);
        }

        .ai-chat-send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #FF6B35;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto;
                height: auto;
                min-height: calc(100vh - 70px);
            }
            
            .panel {
                grid-area: auto;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            body {
                overflow: auto;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                height: auto;
                padding: 15px;
                gap: 15px;
            }
            
            .main-content {
                padding: 10px;
                gap: 15px;
            }
            
            .panel {
                padding: 15px;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .b2b-grid {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(3, 1fr);
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .ai-grid {
                grid-template-columns: 1fr;
            }
            
            .deepseek-badge {
                font-size: 8px;
                padding: 1px 4px;
            }
            
            /* ç§»åŠ¨ç«¯AIåŠ©æ‰‹è°ƒæ•´ */
            .ai-assistant {
                left: 15px;
                bottom: 80px;
                top: auto;
                transform: none;
            }
            
            .ai-assistant-button {
                width: 60px;
                height: 60px;
            }
            
            .ai-assistant-avatar {
                width: 42px;
                height: 42px;
            }
            
            .ai-chat-modal {
                left: 15px;
                right: 15px;
                top: 50px;
                bottom: 50px;
                width: auto;
                height: auto;
                transform: none;
            }
            
            .ai-chat-modal.show {
                animation: slideInUp 0.3s ease;
            }
            
            @keyframes slideInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="navbar">
        <div class="logo">
            <img src="logo.png" alt="Logo">
            <span class="logo-text">å‘¨åº¦æ•°æ®åˆ†æçœ‹æ¿</span>
        </div>
        <select id="weekSelect" class="week-dropdown">
            <option value="">é€‰æ‹©å‘¨åº¦...</option>
        </select>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ - å››å®«æ ¼å¸ƒå±€ -->
    <div class="main-content">
        <!-- å·¦ä¸Šï¼šå‘¨åº¦æ ¸å¿ƒæ•°æ®æŒ‡æ ‡ -->
        <div class="panel core-metrics">
            <h3 class="panel-title">å‘¨åº¦æ ¸å¿ƒæ•°æ®æŒ‡æ ‡</h3>
            <div class="metrics-grid">
                <!-- ç”¨æˆ·æŒ‡æ ‡ -->
                <div class="metric-group">
                    <h4>ç”¨æˆ·æŒ‡æ ‡</h4>
                    <div class="metric-item">
                        <span class="metric-label">æ´»è·ƒç”¨æˆ·</span>
                        <span class="metric-value" id="activeUsers">-</span>
                        <div class="metric-changes">
                            <span class="change-item" id="activeUsersWoW">ç¯æ¯”: -</span>
                            <span class="change-item" id="activeUsersYoY">åŒæ¯”: -</span>
                        </div>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">æ¬¡å‘¨ç•™å­˜ç‡</span>
                        <span class="metric-value" id="retention">-</span>
                        <div class="metric-changes">
                            <span class="change-item" id="retentionWoW">ç¯æ¯”: -</span>
                            <span class="change-item" id="retentionYoY">åŒæ¯”: -</span>
                        </div>
                    </div>
                </div>

                <!-- æ”¶å…¥æŒ‡æ ‡ -->
                <div class="metric-group">
                    <h4>æ”¶å…¥æŒ‡æ ‡</h4>
                    <div class="metric-item">
                        <span class="metric-label">è¥æ”¶</span>
                        <span class="metric-value" id="revenue">-</span>
                        <div class="metric-changes">
                            <span class="change-item" id="revenueWoW">ç¯æ¯”: -</span>
                            <span class="change-item" id="revenueYoY">åŒæ¯”: -</span>
                        </div>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">ARPU</span>
                        <span class="metric-value" id="arpu">-</span>
                        <div class="metric-changes">
                            <span class="change-item" id="arpuWoW">ç¯æ¯”: -</span>
                            <span class="change-item" id="arpuYoY">åŒæ¯”: -</span>
                        </div>
                    </div>
                </div>

                <!-- ä½¿ç”¨æŒ‡æ ‡ -->
                <div class="metric-group">
                    <h4>ä½¿ç”¨æŒ‡æ ‡</h4>
                    <div class="metric-item">
                        <span class="metric-label">æ·±åº¦è®¿é—®ç‡</span>
                        <span class="metric-value" id="deepAccess">-</span>
                        <div class="metric-changes">
                            <span class="change-item" id="deepAccessWoW">ç¯æ¯”: -</span>
                            <span class="change-item" id="deepAccessYoY">åŒæ¯”: -</span>
                        </div>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">ä½¿ç”¨ç‡</span>
                        <span class="metric-value" id="usageRate">-</span>
                        <div class="metric-changes">
                            <span class="change-item" id="usageRateWoW">ç¯æ¯”: -</span>
                            <span class="change-item" id="usageRateYoY">åŒæ¯”: -</span>
                        </div>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">å¤§ä¼šå‘˜æ´»è·ƒç‡</span>
                        <span class="metric-value" id="vipActive">-</span>
                        <div class="metric-changes">
                            <span class="change-item" id="vipActiveWoW">ç¯æ¯”: -</span>
                            <span class="change-item" id="vipActiveYoY">åŒæ¯”: -</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¸Šï¼šè¶‹åŠ¿åˆ†æ -->
        <div class="panel trends-analysis">
            <h3 class="panel-title">è¶‹åŠ¿åˆ†æ</h3>
            <div class="trends-header">
                <div class="period-selector">
                    <button class="period-btn" data-weeks="2">è¿‘2å‘¨</button>
                    <button class="period-btn active" data-weeks="3">è¿‘3å‘¨</button>
                    <button class="period-btn" data-weeks="4">è¿‘4å‘¨</button>
                </div>
            </div>
            <div class="charts-container">
                <div class="chart-item">
                    <h5>æ´»è·ƒç”¨æˆ·è¶‹åŠ¿</h5>
                    <canvas id="activeUsersChart"></canvas>
                </div>
                <div class="chart-item">
                    <h5>ä»˜è´¹ç”¨æˆ·è¶‹åŠ¿</h5>
                    <canvas id="paidUsersChart"></canvas>
                </div>
                <div class="chart-item">
                    <h5>è¥æ”¶è¶‹åŠ¿</h5>
                    <canvas id="revenueChart"></canvas>
                </div>
                <div class="chart-item">
                    <h5>ä½¿ç”¨ç‡è¶‹åŠ¿</h5>
                    <canvas id="usageChart"></canvas>
                </div>
            </div>
        </div>

        <!-- å·¦ä¸‹ï¼šBç«¯æ ¸å¿ƒæ•°æ®æŒ‡æ ‡ -->
        <div class="panel b2b-metrics">
            <h3 class="panel-title">Bç«¯æ ¸å¿ƒæ•°æ®æŒ‡æ ‡</h3>
            <div class="b2b-grid" id="b2bMetrics">
                <!-- Bç«¯æŒ‡æ ‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å³ä¸‹ï¼šAIæ•°æ®åˆ†æ -->
        <div class="panel ai-analysis">
            <div class="ai-header">
                <h3 class="ai-title">ğŸ¤– AIæ•°æ®åˆ†æ</h3>
            </div>
            <div class="ai-content">
                <div class="ai-grid" id="aiAnalysis">
                    <div class="loading">æ­£åœ¨åˆ†ææ•°æ®...</div>
                </div>
            </div>
            <div class="ai-footer">
                <div class="ai-status">
                    <button class="status-btn active">æ™ºèƒ½åˆ†æ</button>
                    <button class="status-btn refresh">åˆ·æ–°åˆ†æ</button>
                </div>
                <div class="ai-credit">ç”± DeepSeek AI æä¾›æŠ€æœ¯æ”¯æŒ</div>
            </div>
        </div>
    </div>

    <!-- å°æ©™å­AIåŠ©æ‰‹ -->
    <div class="ai-assistant">
        <div class="ai-assistant-button" id="aiAssistantBtn">
            <img src="å°æ©™å­.png" alt="å°æ©™å­AIåŠ©æ‰‹" class="ai-assistant-avatar">
            <div class="ai-assistant-pulse"></div>
        </div>
        
        <!-- AIå¯¹è¯æ¡† -->
        <div class="ai-chat-modal" id="aiChatModal">
            <div class="ai-chat-container">
                <div class="ai-chat-header">
                    <div class="ai-chat-avatar">
                        <img src="å°æ©™å­.png" alt="å°æ©™å­">
                    </div>
                    <div class="ai-chat-info">
                        <h4>å°æ©™å­</h4>
                        <span>AIæ•°æ®åˆ†æåŠ©æ‰‹</span>
                    </div>
                    <button class="ai-chat-close" id="aiChatClose">Ã—</button>
                </div>
                
                <div class="ai-chat-messages" id="aiChatMessages">
                    <div class="ai-message">
                        <div class="ai-message-avatar">
                            <img src="å°æ©™å­.png" alt="å°æ©™å­">
                        </div>
                        <div class="ai-message-content">
                            <div class="ai-message-bubble">
                                æ‚¨å¥½ï¼æˆ‘æ˜¯ä½ çš„AIæ•°æ®åˆ†æåŠ©æ‰‹å°æ©™å­ğŸŠï¼Œæœ‰ä»€ä¹ˆéœ€è¦æˆ‘å¸®åŠ©çš„å—ï¼Ÿæˆ‘å¯ä»¥å¸®æ‚¨åˆ†ææ•°æ®è¶‹åŠ¿ã€è§£è¯»æŒ‡æ ‡å˜åŒ–ã€æä¾›è¿è¥å»ºè®®ç­‰ã€‚
                            </div>
                            <div class="ai-message-time">åˆšåˆš</div>
                        </div>
                    </div>
                </div>
                
                <div class="ai-chat-input-area">
                    <div class="ai-chat-suggestions">
                        <button class="suggestion-btn" data-question="åˆ†æä¸€ä¸‹æœ¬å‘¨çš„ç”¨æˆ·å˜åŒ–æƒ…å†µ">åˆ†æç”¨æˆ·å˜åŒ–</button>
                        <button class="suggestion-btn" data-question="è¥æ”¶ä¸‹é™çš„ä¸»è¦åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ">è¥æ”¶åˆ†æ</button>
                        <button class="suggestion-btn" data-question="ç»™å‡ºæå‡ä½¿ç”¨ç‡çš„å»ºè®®">ä½¿ç”¨ç‡å»ºè®®</button>
                    </div>
                    <div class="ai-chat-input-container">
                        <input type="text" id="aiChatInput" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." maxlength="500">
                        <button id="aiChatSend" class="ai-chat-send-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let weeklyData = [];
        let b2bData = [];
        let currentWeek = null;
        let charts = {};
        let aiChatHistory = []; // AIå¯¹è¯å†å²

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // ç­‰å¾…Chart.jsåŠ è½½å®Œæˆ
            function initWhenReady() {
                if (typeof Chart !== 'undefined') {
                    console.log('Chart.jså·²åŠ è½½ï¼Œå¼€å§‹åˆå§‹åŒ–åº”ç”¨');
                    initializeApp();
                } else {
                    console.log('ç­‰å¾…Chart.jsåŠ è½½...');
                    setTimeout(initWhenReady, 100);
                }
            }
            
            initWhenReady();
        });

        // åˆå§‹åŒ–åº”ç”¨
        function initializeApp() {
            loadHardcodedData();
            setupEventListeners();
            setupAIAssistant(); // åˆå§‹åŒ–AIåŠ©æ‰‹
            populateWeekSelector();
            updateB2BMetrics();
            
            // é»˜è®¤é€‰æ‹©æœ€æ–°å‘¨åº¦
            if (weeklyData.length > 0) {
                const latestWeek = weeklyData[weeklyData.length - 1];
                currentWeek = { year: latestWeek.å¹´ä»½, week: latestWeek.å‘¨æ•° };
                document.getElementById('weekSelect').value = JSON.stringify(currentWeek);
                updateAllMetrics();
                updateCharts();
                generateAIAnalysis();
            }
        }

        // åŠ è½½ç¡¬ç¼–ç æ•°æ®
        function loadHardcodedData() {
            console.log('åŠ è½½æ•°æ®...');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰åµŒå…¥çš„æ•°æ®
            if (typeof dashboardData !== 'undefined') {
                console.log('ä½¿ç”¨åµŒå…¥çš„data.jsæ•°æ®');
                
                // åŠ è½½å‘¨åº¦æ ¸å¿ƒæ•°æ®
                if (dashboardData['å‘¨åº¦æ ¸å¿ƒæ•°æ®_utf8']) {
                    weeklyData = dashboardData['å‘¨åº¦æ ¸å¿ƒæ•°æ®_utf8'].map(row => ({
                        å¹´ä»½: parseInt(row['å¹´ä»½']),
                        å‘¨æ•°: parseInt(row['å‘¨æ•°'].replace(/[^0-9]/g, '')),
                        èµ·å§‹æ—¥æœŸ: row['èµ·å§‹æ—¥æœŸ'],
                        ç»“å°¾æ—¥æœŸ: row['ç»“å°¾æ—¥æœŸ'],
                        æ´»è·ƒç”¨æˆ·: parseInt(row['æ´»è·ƒç”¨æˆ·']),
                        æ¬¡å‘¨ç•™å­˜ç‡: parseFloat(row['æ¬¡å‘¨ç•™å­˜ç‡'].replace('%', '')),
                        è¥æ”¶: parseFloat(row['è¥æ”¶']),
                        ARPU: parseFloat(row['ARPU']),
                        æ·±åº¦è®¿é—®ç‡: parseFloat(row['æ·±åº¦è®¿é—®ç‡'].replace('%', '')),
                        ä½¿ç”¨ç‡: parseFloat(row['ä½¿ç”¨ç‡'].replace('%', '')),
                        å¤§ä¼šå‘˜æ´»è·ƒç‡: parseFloat(row['å¤§ä¼šå‘˜æ´»è·ƒç‡'].replace('%', ''))
                    }));
                    console.log('å‘¨åº¦æ ¸å¿ƒæ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', weeklyData.length, 'æ¡');
                }
                
                // åŠ è½½Bç«¯æ ¸å¿ƒæ•°æ®
                if (dashboardData['Bç«¯æ ¸å¿ƒæ•°æ®_utf8']) {
                    // Bç«¯æ•°æ®ç»“æ„ä¸åŒï¼Œéœ€è¦ä»æ—¥æœŸæ¨ç®—å¹´ä»½å’Œå‘¨æ•°
                    b2bData = dashboardData['Bç«¯æ ¸å¿ƒæ•°æ®_utf8'].map((row, index) => {
                        // ä»èµ·å§‹æ—¥æœŸæå–å¹´ä»½
                        const dateMatch = row['èµ·å§‹æ—¥æœŸ'].match(/(\d{4})å¹´/);
                        const year = dateMatch ? parseInt(dateMatch[1]) : 2026;
                        const weekNum = index + 1; // ç®€å•é€’å¢å‘¨æ•°
                        
                        return {
                            å¹´ä»½: year,
                            å‘¨æ•°: weekNum,
                            èµ·å§‹æ—¥æœŸ: row['èµ·å§‹æ—¥æœŸ'],
                            ç»“å°¾æ—¥æœŸ: row['ç»“å°¾æ—¥æœŸ'],
                            ç­¾çº¦é‡‘é¢: row['ç­¾çº¦é‡‘é¢'],
                            å¼€ç¥¨é‡‘é¢: row['å¼€ç¥¨é‡‘é¢'],
                            å›æ¬¾é‡‘é¢: row['å›æ¬¾é‡‘é¢'],
                            è®¢å•æ•°: row['è®¢å•æ•°'],
                            æ–°ç­¾: row['æ–°ç­¾'],
                            ç»­ç­¾: row['ç»­ç­¾']
                        };
                    });
                    console.log('Bç«¯æ ¸å¿ƒæ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', b2bData.length, 'æ¡');
                }
                
                // åŠ è½½æ—¥åº¦æ•°æ®
                if (dashboardData['æ´»è·ƒç”¨æˆ·è¶‹åŠ¿_utf8']) {
                    window.dailyActiveUsers = dashboardData['æ´»è·ƒç”¨æˆ·è¶‹åŠ¿_utf8'].map(row => ({
                        date: row['dt'],
                        uv: parseInt(row['uv'])
                    }));
                    console.log('æ´»è·ƒç”¨æˆ·è¶‹åŠ¿åŠ è½½æˆåŠŸï¼Œå…±', window.dailyActiveUsers.length, 'æ¡');
                }
                
                if (dashboardData['ä»˜è´¹ç”¨æˆ·åŠè¥æ”¶è¶‹åŠ¿_utf8']) {
                    window.dailyPaidUsers = dashboardData['ä»˜è´¹ç”¨æˆ·åŠè¥æ”¶è¶‹åŠ¿_utf8'].map(row => ({
                        date: row['dt'],
                        paidUsers: parseInt(row['ä»˜è´¹ç”¨æˆ·']),
                        revenue: parseFloat(row['è¥æ”¶'])
                    }));
                    console.log('ä»˜è´¹ç”¨æˆ·åŠè¥æ”¶è¶‹åŠ¿åŠ è½½æˆåŠŸï¼Œå…±', window.dailyPaidUsers.length, 'æ¡');
                }
                
                if (dashboardData['ä½¿ç”¨ç‡è¶‹åŠ¿_utf8']) {
                    window.dailyUsageRate = dashboardData['ä½¿ç”¨ç‡è¶‹åŠ¿_utf8'].map(row => ({
                        date: row['date'],
                        usageRate: parseFloat(row['ä½¿ç”¨ç‡ç™¾åˆ†æ¯”'])
                    }));
                    console.log('ä½¿ç”¨ç‡è¶‹åŠ¿åŠ è½½æˆåŠŸï¼Œå…±', window.dailyUsageRate.length, 'æ¡');
                }
                
                return;
            }
            
            console.log('ä½¿ç”¨å†…ç½®ç¡¬ç¼–ç æ•°æ®...');
            
            // å‘¨åº¦æ ¸å¿ƒæ•°æ®
            weeklyData = [
                {
                    å¹´ä»½: 2025,
                    å‘¨æ•°: 1,
                    èµ·å§‹æ—¥æœŸ: '2025å¹´1æœˆ1æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2025å¹´1æœˆ7æ—¥',
                    æ´»è·ƒç”¨æˆ·: 119000,
                    æ¬¡å‘¨ç•™å­˜ç‡: 46,
                    è¥æ”¶: 199039,
                    ARPU: 1.67,
                    æ·±åº¦è®¿é—®ç‡: 84,
                    ä½¿ç”¨ç‡: 65,
                    å¤§ä¼šå‘˜æ´»è·ƒç‡: 61
                },
                {
                    å¹´ä»½: 2025,
                    å‘¨æ•°: 2,
                    èµ·å§‹æ—¥æœŸ: '2025å¹´1æœˆ8æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2025å¹´1æœˆ14æ—¥',
                    æ´»è·ƒç”¨æˆ·: 125585,
                    æ¬¡å‘¨ç•™å­˜ç‡: 38,
                    è¥æ”¶: 173441,
                    ARPU: 1.38,
                    æ·±åº¦è®¿é—®ç‡: 83,
                    ä½¿ç”¨ç‡: 62,
                    å¤§ä¼šå‘˜æ´»è·ƒç‡: 57
                },
                {
                    å¹´ä»½: 2025,
                    å‘¨æ•°: 3,
                    èµ·å§‹æ—¥æœŸ: '2025å¹´1æœˆ15æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2025å¹´1æœˆ21æ—¥',
                    æ´»è·ƒç”¨æˆ·: 96407,
                    æ¬¡å‘¨ç•™å­˜ç‡: 27,
                    è¥æ”¶: 100709,
                    ARPU: 1.04,
                    æ·±åº¦è®¿é—®ç‡: 77,
                    ä½¿ç”¨ç‡: 52,
                    å¤§ä¼šå‘˜æ´»è·ƒç‡: 43
                },
                {
                    å¹´ä»½: 2025,
                    å‘¨æ•°: 4,
                    èµ·å§‹æ—¥æœŸ: '2025å¹´1æœˆ22æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2025å¹´1æœˆ28æ—¥',
                    æ´»è·ƒç”¨æˆ·: 59814,
                    æ¬¡å‘¨ç•™å­˜ç‡: 21,
                    è¥æ”¶: 76057,
                    ARPU: 1.27,
                    æ·±åº¦è®¿é—®ç‡: 75,
                    ä½¿ç”¨ç‡: 51,
                    å¤§ä¼šå‘˜æ´»è·ƒç‡: 32
                },
                {
                    å¹´ä»½: 2025,
                    å‘¨æ•°: 5,
                    èµ·å§‹æ—¥æœŸ: '2025å¹´1æœˆ29æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2025å¹´2æœˆ4æ—¥',
                    æ´»è·ƒç”¨æˆ·: 45572,
                    æ¬¡å‘¨ç•™å­˜ç‡: 24,
                    è¥æ”¶: 63968,
                    ARPU: 1.40,
                    æ·±åº¦è®¿é—®ç‡: 76,
                    ä½¿ç”¨ç‡: 52,
                    å¤§ä¼šå‘˜æ´»è·ƒç‡: 27
                },
                {
                    å¹´ä»½: 2026,
                    å‘¨æ•°: 1,
                    èµ·å§‹æ—¥æœŸ: '2026å¹´1æœˆ1æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2026å¹´1æœˆ7æ—¥',
                    æ´»è·ƒç”¨æˆ·: 103932,
                    æ¬¡å‘¨ç•™å­˜ç‡: 42,
                    è¥æ”¶: 232351,
                    ARPU: 2.24,
                    æ·±åº¦è®¿é—®ç‡: 83,
                    ä½¿ç”¨ç‡: 74,
                    å¤§ä¼šå‘˜æ´»è·ƒç‡: 50
                },
                {
                    å¹´ä»½: 2026,
                    å‘¨æ•°: 2,
                    èµ·å§‹æ—¥æœŸ: '2026å¹´1æœˆ8æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2026å¹´1æœˆ14æ—¥',
                    æ´»è·ƒç”¨æˆ·: 117167,
                    æ¬¡å‘¨ç•™å­˜ç‡: 43,
                    è¥æ”¶: 303052,
                    ARPU: 2.59,
                    æ·±åº¦è®¿é—®ç‡: 85,
                    ä½¿ç”¨ç‡: 75,
                    å¤§ä¼šå‘˜æ´»è·ƒç‡: 51
                },
                {
                    å¹´ä»½: 2026,
                    å‘¨æ•°: 3,
                    èµ·å§‹æ—¥æœŸ: '2026å¹´1æœˆ15æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2026å¹´1æœˆ21æ—¥',
                    æ´»è·ƒç”¨æˆ·: 133661,
                    æ¬¡å‘¨ç•™å­˜ç‡: 44,
                    è¥æ”¶: 298800,
                    ARPU: 2.24,
                    æ·±åº¦è®¿é—®ç‡: 86,
                    ä½¿ç”¨ç‡: 75,
                    å¤§ä¼šå‘˜æ´»è·ƒç‡: 52
                },
                {
                    å¹´ä»½: 2026,
                    å‘¨æ•°: 4,
                    èµ·å§‹æ—¥æœŸ: '2026å¹´1æœˆ22æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2026å¹´1æœˆ28æ—¥',
                    æ´»è·ƒç”¨æˆ·: 137602,
                    æ¬¡å‘¨ç•™å­˜ç‡: 42,
                    è¥æ”¶: 270348,
                    ARPU: 1.96,
                    æ·±åº¦è®¿é—®ç‡: 86,
                    ä½¿ç”¨ç‡: 75,
                    å¤§ä¼šå‘˜æ´»è·ƒç‡: 50
                },
                {
                    å¹´ä»½: 2026,
                    å‘¨æ•°: 5,
                    èµ·å§‹æ—¥æœŸ: '2026å¹´1æœˆ29æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2026å¹´2æœˆ4æ—¥',
                    æ´»è·ƒç”¨æˆ·: 115358,
                    æ¬¡å‘¨ç•™å­˜ç‡: 36,
                    è¥æ”¶: 206613,
                    ARPU: 1.79,
                    æ·±åº¦è®¿é—®ç‡: 83,
                    ä½¿ç”¨ç‡: 67,
                    å¤§ä¼šå‘˜æ´»è·ƒç‡: 45
                },
                {
                    å¹´ä»½: 2025,
                    å‘¨æ•°: 6,
                    èµ·å§‹æ—¥æœŸ: '2025å¹´2æœˆ5æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2025å¹´2æœˆ11æ—¥',
                    æ´»è·ƒç”¨æˆ·: 58613,
                    æ¬¡å‘¨ç•™å­˜ç‡: 30,
                    è¥æ”¶: 94922,
                    ARPU: 1.62,
                    æ·±åº¦è®¿é—®ç‡: 77,
                    ä½¿ç”¨ç‡: 55,
                    å¤§ä¼šå‘˜æ´»è·ƒç‡: 35
                },
                {
                    å¹´ä»½: 2025,
                    å‘¨æ•°: 7,
                    èµ·å§‹æ—¥æœŸ: '2025å¹´2æœˆ12æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2025å¹´2æœˆ18æ—¥',
                    æ´»è·ƒç”¨æˆ·: 55670,
                    æ¬¡å‘¨ç•™å­˜ç‡: 27,
                    è¥æ”¶: 114548,
                    ARPU: 2.06,
                    æ·±åº¦è®¿é—®ç‡: 77,
                    ä½¿ç”¨ç‡: 54,
                    å¤§ä¼šå‘˜æ´»è·ƒç‡: 39
                },
                {
                    å¹´ä»½: 2026,
                    å‘¨æ•°: 6,
                    èµ·å§‹æ—¥æœŸ: '2026å¹´2æœˆ5æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2026å¹´2æœˆ11æ—¥',
                    æ´»è·ƒç”¨æˆ·: 80892,
                    æ¬¡å‘¨ç•™å­˜ç‡: 29,
                    è¥æ”¶: 156161,
                    ARPU: 1.93,
                    æ·±åº¦è®¿é—®ç‡: 77,
                    ä½¿ç”¨ç‡: 60,
                    å¤§ä¼šå‘˜æ´»è·ƒç‡: 36
                },
                {
                    å¹´ä»½: 2026,
                    å‘¨æ•°: 7,
                    èµ·å§‹æ—¥æœŸ: '2026å¹´2æœˆ12æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2026å¹´2æœˆ18æ—¥',
                    æ´»è·ƒç”¨æˆ·: 48301,
                    æ¬¡å‘¨ç•™å­˜ç‡: 25,
                    è¥æ”¶: 79576,
                    ARPU: 1.65,
                    æ·±åº¦è®¿é—®ç‡: 75,
                    ä½¿ç”¨ç‡: 58,
                    å¤§ä¼šå‘˜æ´»è·ƒç‡: 26
                },
                {
                    å¹´ä»½: 2025,
                    å‘¨æ•°: 8,
                    èµ·å§‹æ—¥æœŸ: '2025å¹´2æœˆ19æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2025å¹´2æœˆ25æ—¥',
                    æ´»è·ƒç”¨æˆ·: 54060,
                    æ¬¡å‘¨ç•™å­˜ç‡: 29,
                    è¥æ”¶: 114026,
                    ARPU: 2.11,
                    æ·±åº¦è®¿é—®ç‡: 78,
                    ä½¿ç”¨ç‡: 54,
                    å¤§ä¼šå‘˜æ´»è·ƒç‡: 39
                },
                {
                    å¹´ä»½: 2026,
                    å‘¨æ•°: 8,
                    èµ·å§‹æ—¥æœŸ: '2026å¹´2æœˆ19æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2026å¹´2æœˆ25æ—¥',
                    æ´»è·ƒç”¨æˆ·: 57801,
                    æ¬¡å‘¨ç•™å­˜ç‡: 37,
                    è¥æ”¶: 130922,
                    ARPU: 2.27,
                    æ·±åº¦è®¿é—®ç‡: 77,
                    ä½¿ç”¨ç‡: 62,
                    å¤§ä¼šå‘˜æ´»è·ƒç‡: 32
                }
            ];

            // Bç«¯æ•°æ®
            b2bData = [
                {
                    èµ·å§‹æ—¥æœŸ: '2026å¹´1æœˆ1æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2026å¹´1æœˆ7æ—¥',
                    ç­¾çº¦é‡‘é¢: '1.80ä¸‡',
                    å¼€ç¥¨é‡‘é¢: '3.05ä¸‡',
                    å›æ¬¾é‡‘é¢: '2.00ä¸‡',
                    è®¢å•æ•°: 3,
                    æ–°ç­¾: 1,
                    ç»­ç­¾: 2
                },
                {
                    èµ·å§‹æ—¥æœŸ: '2026å¹´1æœˆ8æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2026å¹´1æœˆ14æ—¥',
                    ç­¾çº¦é‡‘é¢: '5.30ä¸‡',
                    å¼€ç¥¨é‡‘é¢: '1.60ä¸‡',
                    å›æ¬¾é‡‘é¢: '4.40ä¸‡',
                    è®¢å•æ•°: 4,
                    æ–°ç­¾: 1,
                    ç»­ç­¾: 3
                },
                {
                    èµ·å§‹æ—¥æœŸ: '2026å¹´1æœˆ15æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2026å¹´1æœˆ21æ—¥',
                    ç­¾çº¦é‡‘é¢: '4.89ä¸‡',
                    å¼€ç¥¨é‡‘é¢: '1.26ä¸‡',
                    å›æ¬¾é‡‘é¢: '3.66ä¸‡',
                    è®¢å•æ•°: 7,
                    æ–°ç­¾: 5,
                    ç»­ç­¾: 2
                },
                {
                    èµ·å§‹æ—¥æœŸ: '2026å¹´1æœˆ22æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2026å¹´1æœˆ28æ—¥',
                    ç­¾çº¦é‡‘é¢: '4.36ä¸‡',
                    å¼€ç¥¨é‡‘é¢: '6.91ä¸‡',
                    å›æ¬¾é‡‘é¢: '4.36ä¸‡',
                    è®¢å•æ•°: 5,
                    æ–°ç­¾: 1,
                    ç»­ç­¾: 4
                },
                {
                    èµ·å§‹æ—¥æœŸ: '2026å¹´1æœˆ29æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2026å¹´2æœˆ4æ—¥',
                    ç­¾çº¦é‡‘é¢: '4.00ä¸‡',
                    å¼€ç¥¨é‡‘é¢: '0.00ä¸‡',
                    å›æ¬¾é‡‘é¢: '2.00ä¸‡',
                    è®¢å•æ•°: 2,
                    æ–°ç­¾: 2,
                    ç»­ç­¾: 0
                },
                {
                    èµ·å§‹æ—¥æœŸ: '2026å¹´2æœˆ5æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2026å¹´2æœˆ11æ—¥',
                    ç­¾çº¦é‡‘é¢: '2.10ä¸‡',
                    å¼€ç¥¨é‡‘é¢: '2.45ä¸‡',
                    å›æ¬¾é‡‘é¢: '1.75ä¸‡',
                    è®¢å•æ•°: 2,
                    æ–°ç­¾: 0,
                    ç»­ç­¾: 2
                },
                {
                    èµ·å§‹æ—¥æœŸ: '2026å¹´2æœˆ12æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2026å¹´2æœˆ18æ—¥',
                    ç­¾çº¦é‡‘é¢: '0.00ä¸‡',
                    å¼€ç¥¨é‡‘é¢: '0.00ä¸‡',
                    å›æ¬¾é‡‘é¢: '1.00ä¸‡',
                    è®¢å•æ•°: 0,
                    æ–°ç­¾: 0,
                    ç»­ç­¾: 0
                },
                {
                    èµ·å§‹æ—¥æœŸ: '2026å¹´2æœˆ19æ—¥',
                    ç»“å°¾æ—¥æœŸ: '2026å¹´2æœˆ25æ—¥',
                    ç­¾çº¦é‡‘é¢: '0.00ä¸‡',
                    å¼€ç¥¨é‡‘é¢: '4.00ä¸‡',
                    å›æ¬¾é‡‘é¢: '0.00ä¸‡',
                    è®¢å•æ•°: 0,
                    æ–°ç­¾: 0,
                    ç»­ç­¾: 0
                }
            ];

            // æ¯æ—¥è¶‹åŠ¿æ•°æ®
            loadDailyTrendData();

            console.log('æ•°æ®åŠ è½½å®Œæˆ:', { weeklyData, b2bData });
        }

        // åŠ è½½æ¯æ—¥è¶‹åŠ¿æ•°æ®
        function loadDailyTrendData() {
            // æ´»è·ƒç”¨æˆ·æ¯æ—¥æ•°æ®
            window.dailyActiveUsers = [
                { date: '2026/1/1', uv: 22054 },
                { date: '2026/1/2', uv: 27358 },
                { date: '2026/1/3', uv: 30989 },
                { date: '2026/1/4', uv: 21786 },
                { date: '2026/1/5', uv: 23213 },
                { date: '2026/1/6', uv: 24064 },
                { date: '2026/1/7', uv: 25342 },
                { date: '2026/1/8', uv: 25628 },
                { date: '2026/1/9', uv: 24084 },
                { date: '2026/1/10', uv: 32033 },
                { date: '2026/1/11', uv: 37160 },
                { date: '2026/1/12', uv: 26331 },
                { date: '2026/1/13', uv: 27026 },
                { date: '2026/1/14', uv: 28507 },
                { date: '2026/1/15', uv: 28668 },
                { date: '2026/1/16', uv: 28278 },
                { date: '2026/1/17', uv: 38770 },
                { date: '2026/1/18', uv: 43999 },
                { date: '2026/1/19', uv: 30309 },
                { date: '2026/1/20', uv: 30876 },
                { date: '2026/1/21', uv: 30947 },
                { date: '2026/1/22', uv: 30836 },
                { date: '2026/1/23', uv: 29666 },
                { date: '2026/1/24', uv: 40933 },
                { date: '2026/1/25', uv: 45337 },
                { date: '2026/1/26', uv: 31735 },
                { date: '2026/1/27', uv: 31854 },
                { date: '2026/1/28', uv: 31571 },
                { date: '2026/1/29', uv: 29447 },
                { date: '2026/1/30', uv: 28003 },
                { date: '2026/1/31', uv: 33100 },
                { date: '2026/2/1', uv: 31908 },
                { date: '2026/2/2', uv: 25302 },
                { date: '2026/2/3', uv: 23678 },
                { date: '2026/2/4', uv: 22589 },
                { date: '2026/2/5', uv: 21337 },
                { date: '2026/2/6', uv: 20618 },
                { date: '2026/2/7', uv: 19610 },
                { date: '2026/2/8', uv: 18048 },
                { date: '2026/2/9', uv: 17186 },
                { date: '2026/2/10', uv: 16432 },
                { date: '2026/2/11', uv: 15780 },
                { date: '2026/2/12', uv: 15099 },
                { date: '2026/2/13', uv: 14099 },
                { date: '2026/2/14', uv: 12332 },
                { date: '2026/2/15', uv: 10532 },
                { date: '2026/2/16', uv: 6556 },
                { date: '2026/2/17', uv: 6786 },
                { date: '2026/2/18', uv: 8443 },
                { date: '2026/2/19', uv: 9838 },
                { date: '2026/2/20', uv: 11176 },
                { date: '2026/2/21', uv: 12182 },
                { date: '2026/2/22', uv: 13458 },
                { date: '2026/2/23', uv: 14756 },
                { date: '2026/2/24', uv: 15396 },
                { date: '2026/2/25', uv: 15447 }
            ];

            // ä»˜è´¹ç”¨æˆ·æ¯æ—¥æ•°æ®
            window.dailyPaidUsers = [
                { date: '2026/1/1', paidUsers: 345, revenue: 29247 },
                { date: '2026/1/2', paidUsers: 406, revenue: 35488 },
                { date: '2026/1/3', paidUsers: 437, revenue: 39576 },
                { date: '2026/1/4', paidUsers: 342, revenue: 27809 },
                { date: '2026/1/5', paidUsers: 356, revenue: 31528 },
                { date: '2026/1/6', paidUsers: 377, revenue: 36626 },
                { date: '2026/1/7', paidUsers: 364, revenue: 31381 },
                { date: '2026/1/8', paidUsers: 394, revenue: 38861 },
                { date: '2026/1/9', paidUsers: 365, revenue: 32735 },
                { date: '2026/1/10', paidUsers: 589, revenue: 58350 },
                { date: '2026/1/11', paidUsers: 644, revenue: 62932 },
                { date: '2026/1/12', paidUsers: 412, revenue: 37436 },
                { date: '2026/1/13', paidUsers: 393, revenue: 33818 },
                { date: '2026/1/14', paidUsers: 417, revenue: 38871 },
                { date: '2026/1/15', paidUsers: 342, revenue: 32175 },
                { date: '2026/1/16', paidUsers: 414, revenue: 41424 },
                { date: '2026/1/17', paidUsers: 620, revenue: 61948 },
                { date: '2026/1/18', paidUsers: 659, revenue: 62795 },
                { date: '2026/1/19', paidUsers: 360, revenue: 33992 },
                { date: '2026/1/20', paidUsers: 330, revenue: 31301 },
                { date: '2026/1/21', paidUsers: 364, revenue: 34848 },
                { date: '2026/1/22', paidUsers: 331, revenue: 30643 },
                { date: '2026/1/23', paidUsers: 354, revenue: 33719 },
                { date: '2026/1/24', paidUsers: 598, revenue: 59098 },
                { date: '2026/1/25', paidUsers: 580, revenue: 54974 },
                { date: '2026/1/26', paidUsers: 327, revenue: 31842 },
                { date: '2026/1/27', paidUsers: 301, revenue: 30500 },
                { date: '2026/1/28', paidUsers: 302, revenue: 29572 },
                { date: '2026/1/29', paidUsers: 257, revenue: 27585 },
                { date: '2026/1/30', paidUsers: 314, revenue: 31845 },
                { date: '2026/1/31', paidUsers: 407, revenue: 35637 },
                { date: '2026/2/1', paidUsers: 392, revenue: 38243 },
                { date: '2026/2/2', paidUsers: 295, revenue: 28297 },
                { date: '2026/2/3', paidUsers: 240, revenue: 24504 },
                { date: '2026/2/4', paidUsers: 234, revenue: 20502 },
                { date: '2026/2/5', paidUsers: 221, revenue: 21901 },
                { date: '2026/2/6', paidUsers: 249, revenue: 24900 },
                { date: '2026/2/7', paidUsers: 275, revenue: 29330 },
                { date: '2026/2/8', paidUsers: 258, revenue: 23858 },
                { date: '2026/2/9', paidUsers: 207, revenue: 19213 },
                { date: '2026/2/10', paidUsers: 211, revenue: 19309 },
                { date: '2026/2/11', paidUsers: 227, revenue: 17650 },
                { date: '2026/2/12', paidUsers: 190, revenue: 15319 },
                { date: '2026/2/13', paidUsers: 173, revenue: 13725 },
                { date: '2026/2/14', paidUsers: 169, revenue: 16059 },
                { date: '2026/2/15', paidUsers: 111, revenue: 9818 },
                { date: '2026/2/16', paidUsers: 69, revenue: 6575 },
                { date: '2026/2/17', paidUsers: 82, revenue: 8637 },
                { date: '2026/2/18', paidUsers: 94, revenue: 9443 },
                { date: '2026/2/19', paidUsers: 132, revenue: 12390 },
                { date: '2026/2/20', paidUsers: 158, revenue: 15360 },
                { date: '2026/2/21', paidUsers: 148, revenue: 17160 },
                { date: '2026/2/22', paidUsers: 191, revenue: 18193 },
                { date: '2026/2/23', paidUsers: 187, revenue: 20221 },
                { date: '2026/2/24', paidUsers: 246, revenue: 24319 },
                { date: '2026/2/25', paidUsers: 205, revenue: 23279 }
            ];

            // ä½¿ç”¨ç‡æ¯æ—¥æ•°æ®
            window.dailyUsageRate = [
                { date: '2026/1/1', usageRate: 63.68 },
                { date: '2026/1/2', usageRate: 66.87 },
                { date: '2026/1/3', usageRate: 68.95 },
                { date: '2026/1/4', usageRate: 68.11 },
                { date: '2026/1/5', usageRate: 69.35 },
                { date: '2026/1/6', usageRate: 68.51 },
                { date: '2026/1/7', usageRate: 68.4 },
                { date: '2026/1/8', usageRate: 67.55 },
                { date: '2026/1/9', usageRate: 65.83 },
                { date: '2026/1/10', usageRate: 68.12 },
                { date: '2026/1/11', usageRate: 70.15 },
                { date: '2026/1/12', usageRate: 69.06 },
                { date: '2026/1/13', usageRate: 68.82 },
                { date: '2026/1/14', usageRate: 68.38 },
                { date: '2026/1/15', usageRate: 68.39 },
                { date: '2026/1/16', usageRate: 66.28 },
                { date: '2026/1/17', usageRate: 68.85 },
                { date: '2026/1/18', usageRate: 71.07 },
                { date: '2026/1/19', usageRate: 68.87 },
                { date: '2026/1/20', usageRate: 68.76 },
                { date: '2026/1/21', usageRate: 69.48 },
                { date: '2026/1/22', usageRate: 68.69 },
                { date: '2026/1/23', usageRate: 66.37 },
                { date: '2026/1/24', usageRate: 69.23 },
                { date: '2026/1/25', usageRate: 70.43 },
                { date: '2026/1/26', usageRate: 67.56 },
                { date: '2026/1/27', usageRate: 66.66 },
                { date: '2026/1/28', usageRate: 65.1 },
                { date: '2026/1/29', usageRate: 61.79 },
                { date: '2026/1/30', usageRate: 60.31 },
                { date: '2026/1/31', usageRate: 63.28 },
                { date: '2026/2/1', usageRate: 64.87 },
                { date: '2026/2/2', usageRate: 62.74 },
                { date: '2026/2/3', usageRate: 62.46 },
                { date: '2026/2/4', usageRate: 59.05 },
                { date: '2026/2/5', usageRate: 57.30 },
                { date: '2026/2/6', usageRate: 56.93 },
                { date: '2026/2/7', usageRate: 54.42 },
                { date: '2026/2/8', usageRate: 53.87 },
                { date: '2026/2/9', usageRate: 55.02 },
                { date: '2026/2/10', usageRate: 55.39 },
                { date: '2026/2/11', usageRate: 55.11 },
                { date: '2026/2/12', usageRate: 54.43 },
                { date: '2026/2/13', usageRate: 55.47 },
                { date: '2026/2/14', usageRate: 55.30 },
                { date: '2026/2/15', usageRate: 54.19 },
                { date: '2026/2/16', usageRate: 49.95 },
                { date: '2026/2/17', usageRate: 51.44 },
                { date: '2026/2/18', usageRate: 54.19 },
                { date: '2026/2/19', usageRate: 56.52 },
                { date: '2026/2/20', usageRate: 56.83 },
                { date: '2026/2/21', usageRate: 57.79 },
                { date: '2026/2/22', usageRate: 57.95 },
                { date: '2026/2/23', usageRate: 58.24 },
                { date: '2026/2/24', usageRate: 58.47 },
                { date: '2026/2/25', usageRate: 58.18 }
            ];
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            console.log('è®¾ç½®äº‹ä»¶ç›‘å¬å™¨...');
            
            // å‘¨åº¦é€‰æ‹©å™¨
            const weekSelect = document.getElementById('weekSelect');
            if (weekSelect) {
                weekSelect.addEventListener('change', function(e) {
                    console.log('å‘¨åº¦é€‰æ‹©å˜åŒ–:', e.target.value);
                    const selectedWeek = e.target.value;
                    if (selectedWeek) {
                        try {
                            currentWeek = JSON.parse(selectedWeek);
                            console.log('å½“å‰é€‰æ‹©çš„å‘¨åº¦:', currentWeek);
                            updateAllMetrics();
                            updateCharts();
                            updateB2BMetrics(); // æ·»åŠ Bç«¯æ•°æ®æ›´æ–°
                            generateAIAnalysis();
                        } catch (error) {
                            console.error('è§£æå‘¨åº¦æ•°æ®å¤±è´¥:', error);
                        }
                    }
                });
            }

            // è¶‹åŠ¿å›¾å‘¨æœŸé€‰æ‹©å™¨
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    updateCharts();
                });
            });
        }

        // å¡«å……å‘¨åº¦é€‰æ‹©å™¨
        function populateWeekSelector() {
            console.log('å¡«å……å‘¨åº¦é€‰æ‹©å™¨...');
            const select = document.getElementById('weekSelect');
            if (!select) {
                console.error('æ‰¾ä¸åˆ°å‘¨åº¦é€‰æ‹©å™¨å…ƒç´ ');
                return;
            }
            
            select.innerHTML = '<option value="">é€‰æ‹©å‘¨åº¦...</option>';
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            const sortedData = [...weeklyData].sort((a, b) => {
                if (a.å¹´ä»½ !== b.å¹´ä»½) {
                    return b.å¹´ä»½ - a.å¹´ä»½; // å¹´ä»½é™åº
                }
                return b.å‘¨æ•° - a.å‘¨æ•°; // åŒå¹´ä»½å†…å‘¨æ•°é™åº
            });
            
            sortedData.forEach(item => {
                const option = document.createElement('option');
                const weekKey = JSON.stringify({ year: item.å¹´ä»½, week: item.å‘¨æ•° });
                option.value = weekKey;
                option.textContent = `${item.å¹´ä»½}å¹´ç¬¬${item.å‘¨æ•°}å‘¨`;
                select.appendChild(option);
            });
            
            console.log('å‘¨åº¦é€‰æ‹©å™¨å¡«å……å®Œæˆï¼Œå…±', weeklyData.length, 'ä¸ªé€‰é¡¹');
        }

        // æ›´æ–°æ‰€æœ‰æŒ‡æ ‡
        function updateAllMetrics() {
            console.log('æ›´æ–°æ‰€æœ‰æŒ‡æ ‡ï¼Œå½“å‰å‘¨åº¦:', currentWeek);
            
            if (!currentWeek) {
                console.log('æ²¡æœ‰é€‰æ‹©å‘¨åº¦ï¼Œè·³è¿‡æ›´æ–°');
                return;
            }
            
            const currentData = weeklyData.find(item => 
                item.å¹´ä»½ === currentWeek.year && item.å‘¨æ•° === currentWeek.week
            );
            
            if (!currentData) {
                console.log('æ‰¾ä¸åˆ°å½“å‰å‘¨åº¦çš„æ•°æ®');
                return;
            }

            console.log('å½“å‰å‘¨åº¦æ•°æ®:', currentData);

            // è·å–å¯¹æ¯”æ•°æ®
            const lastWeekData = weeklyData.find(item => 
                item.å¹´ä»½ === currentWeek.year && item.å‘¨æ•° === currentWeek.week - 1
            );
            
            const lastYearData = weeklyData.find(item => 
                item.å¹´ä»½ === currentWeek.year - 1 && item.å‘¨æ•° === currentWeek.week
            );

            console.log('ä¸Šå‘¨æ•°æ®:', lastWeekData);
            console.log('å»å¹´åŒæœŸæ•°æ®:', lastYearData);

            // æ›´æ–°æŒ‡æ ‡
            updateMetric('activeUsers', currentData.æ´»è·ƒç”¨æˆ·, lastWeekData?.æ´»è·ƒç”¨æˆ·, lastYearData?.æ´»è·ƒç”¨æˆ·, 'number');
            updateMetric('retention', currentData.æ¬¡å‘¨ç•™å­˜ç‡, lastWeekData?.æ¬¡å‘¨ç•™å­˜ç‡, lastYearData?.æ¬¡å‘¨ç•™å­˜ç‡, 'percent');
            updateMetric('revenue', currentData.è¥æ”¶, lastWeekData?.è¥æ”¶, lastYearData?.è¥æ”¶, 'number');
            updateMetric('arpu', currentData.ARPU, lastWeekData?.ARPU, lastYearData?.ARPU, 'number');
            updateMetric('deepAccess', currentData.æ·±åº¦è®¿é—®ç‡, lastWeekData?.æ·±åº¦è®¿é—®ç‡, lastYearData?.æ·±åº¦è®¿é—®ç‡, 'percent');
            updateMetric('usageRate', currentData.ä½¿ç”¨ç‡, lastWeekData?.ä½¿ç”¨ç‡, lastYearData?.ä½¿ç”¨ç‡, 'percent');
            updateMetric('vipActive', currentData.å¤§ä¼šå‘˜æ´»è·ƒç‡, lastWeekData?.å¤§ä¼šå‘˜æ´»è·ƒç‡, lastYearData?.å¤§ä¼šå‘˜æ´»è·ƒç‡, 'percent');
        }

        // æ›´æ–°å•ä¸ªæŒ‡æ ‡
        function updateMetric(id, current, lastWeek, lastYear, type) {
            console.log(`æ›´æ–°æŒ‡æ ‡ ${id}:`, { current, lastWeek, lastYear, type });
            
            // æ›´æ–°å½“å‰å€¼
            const valueElement = document.getElementById(id);
            if (valueElement) {
                if (type === 'percent') {
                    valueElement.textContent = current + '%';
                } else if (type === 'number') {
                    valueElement.textContent = formatNumber(current);
                }
            }

            // è®¡ç®—å¹¶æ›´æ–°ç¯æ¯”
            const wowElement = document.getElementById(id + 'WoW');
            if (wowElement) {
                if (lastWeek !== undefined) {
                    const wowChange = calculateChange(current, lastWeek, type);
                    wowElement.textContent = `ç¯æ¯”: ${wowChange}`;
                    wowElement.className = 'change-item ' + getChangeClass(wowChange);
                } else {
                    wowElement.textContent = 'ç¯æ¯”: -';
                    wowElement.className = 'change-item';
                }
            }

            // è®¡ç®—å¹¶æ›´æ–°åŒæ¯”
            const yoyElement = document.getElementById(id + 'YoY');
            if (yoyElement) {
                if (lastYear !== undefined) {
                    const yoyChange = calculateChange(current, lastYear, type);
                    yoyElement.textContent = `åŒæ¯”: ${yoyChange}`;
                    yoyElement.className = 'change-item ' + getChangeClass(yoyChange);
                } else {
                    yoyElement.textContent = 'åŒæ¯”: -';
                    yoyElement.className = 'change-item';
                }
            }
        }

        // è®¡ç®—å˜åŒ–
        function calculateChange(current, previous, type) {
            if (type === 'percent') {
                const change = current - previous;
                return (change >= 0 ? '+' : '') + change.toFixed(2) + 'pp';
            } else {
                const change = ((current - previous) / previous * 100);
                return (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
            }
        }

        // è·å–å˜åŒ–æ ·å¼ç±»ï¼ˆä¸­å›½é£æ ¼ï¼šçº¢æ¶¨ç»¿è·Œï¼‰
        function getChangeClass(changeText) {
            if (changeText.includes('+')) return 'positive'; // çº¢è‰²ï¼ˆå¢é•¿ï¼‰
            if (changeText.includes('-') && !changeText.includes('--')) return 'negative'; // ç»¿è‰²ï¼ˆä¸‹é™ï¼‰
            return '';
        }

        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(num) {
            if (num >= 10000) {
                return (num / 10000).toFixed(1) + 'ä¸‡';
            }
            return num.toLocaleString();
        }

        // æ›´æ–°å›¾è¡¨
        function updateCharts() {
            console.log('æ›´æ–°å›¾è¡¨...');
            const activePeriod = document.querySelector('.period-btn.active');
            const weeks = activePeriod ? parseInt(activePeriod.dataset.weeks) : 3;
            
            updateActiveUsersChart(weeks);
            updatePaidUsersChart(weeks);
            updateRevenueChart(weeks);
            updateUsageChart(weeks);
        }

        // è·å–æŒ‡å®šå‘¨æœŸçš„æ¯æ—¥æ•°æ®
        function getDailyDataForPeriod(weeks) {
            if (!currentWeek) return { startDate: null, endDate: null };
            
            // æ‰¾åˆ°å½“å‰é€‰æ‹©å‘¨çš„ç»“æŸæ—¥æœŸ
            const currentWeekData = weeklyData.find(item => 
                item.å¹´ä»½ === currentWeek.year && item.å‘¨æ•° === currentWeek.week
            );
            
            if (!currentWeekData) return { startDate: null, endDate: null };
            
            // è§£æç»“æŸæ—¥æœŸ
            const endDateStr = currentWeekData.ç»“å°¾æ—¥æœŸ.replace(/å¹´|æœˆ|æ—¥/g, '/').replace('//', '/');
            const endDate = new Date(endDateStr);
            
            // è®¡ç®—å¼€å§‹æ—¥æœŸï¼ˆå¾€å‰æ¨æŒ‡å®šå‘¨æ•°ï¼‰
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - (weeks * 7 - 1));
            
            return { startDate, endDate };
        }

        // è¿‡æ»¤æŒ‡å®šæ—¥æœŸèŒƒå›´å†…çš„æ•°æ®
        function filterDataByDateRange(data, startDate, endDate) {
            if (!startDate || !endDate) return [];
            
            return data.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate >= startDate && itemDate <= endDate;
            });
        }

        // æ›´æ–°æ´»è·ƒç”¨æˆ·è¶‹åŠ¿å›¾
        function updateActiveUsersChart(weeks) {
            const ctx = document.getElementById('activeUsersChart');
            if (!ctx) return;
            
            if (charts.activeUsers) {
                charts.activeUsers.destroy();
            }

            const { startDate, endDate } = getDailyDataForPeriod(weeks);
            const filteredData = filterDataByDateRange(window.dailyActiveUsers || [], startDate, endDate);
            
            charts.activeUsers = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: filteredData.map(item => {
                        const date = new Date(item.date);
                        return `${date.getMonth() + 1}/${date.getDate()}`;
                    }),
                    datasets: [{
                        label: 'æ´»è·ƒç”¨æˆ·',
                        data: filteredData.map(item => item.uv),
                        borderColor: '#FF6B35',
                        backgroundColor: 'rgba(255, 107, 53, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: getChartOptions('äºº')
            });
        }

        // æ›´æ–°ä»˜è´¹ç”¨æˆ·è¶‹åŠ¿å›¾
        function updatePaidUsersChart(weeks) {
            const ctx = document.getElementById('paidUsersChart');
            if (!ctx) return;
            
            if (charts.paidUsers) {
                charts.paidUsers.destroy();
            }

            const { startDate, endDate } = getDailyDataForPeriod(weeks);
            const filteredData = filterDataByDateRange(window.dailyPaidUsers || [], startDate, endDate);
            
            charts.paidUsers = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: filteredData.map(item => {
                        const date = new Date(item.date);
                        return `${date.getMonth() + 1}/${date.getDate()}`;
                    }),
                    datasets: [{
                        label: 'ä»˜è´¹ç”¨æˆ·',
                        data: filteredData.map(item => item.paidUsers),
                        borderColor: '#FFA366',
                        backgroundColor: 'rgba(255, 163, 102, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: getChartOptions('äºº')
            });
        }

        // æ›´æ–°è¥æ”¶è¶‹åŠ¿å›¾
        function updateRevenueChart(weeks) {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) return;
            
            if (charts.revenue) {
                charts.revenue.destroy();
            }

            const { startDate, endDate } = getDailyDataForPeriod(weeks);
            const filteredData = filterDataByDateRange(window.dailyPaidUsers || [], startDate, endDate);
            
            charts.revenue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: filteredData.map(item => {
                        const date = new Date(item.date);
                        return `${date.getMonth() + 1}/${date.getDate()}`;
                    }),
                    datasets: [{
                        label: 'è¥æ”¶',
                        data: filteredData.map(item => item.revenue),
                        borderColor: '#FFB366',
                        backgroundColor: 'rgba(255, 179, 102, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: getChartOptions('å…ƒ')
            });
        }

        // æ›´æ–°ä½¿ç”¨ç‡è¶‹åŠ¿å›¾
        function updateUsageChart(weeks) {
            const ctx = document.getElementById('usageChart');
            if (!ctx) return;
            
            if (charts.usage) {
                charts.usage.destroy();
            }

            const { startDate, endDate } = getDailyDataForPeriod(weeks);
            const filteredData = filterDataByDateRange(window.dailyUsageRate || [], startDate, endDate);
            
            charts.usage = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: filteredData.map(item => {
                        const date = new Date(item.date);
                        return `${date.getMonth() + 1}/${date.getDate()}`;
                    }),
                    datasets: [{
                        label: 'ä½¿ç”¨ç‡',
                        data: filteredData.map(item => item.usageRate),
                        borderColor: '#FF6B35',
                        backgroundColor: 'rgba(255, 107, 53, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    ...getChartOptions('%'),
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // è·å–å›¾è¡¨é…ç½®
        function getChartOptions(unit) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (unit === 'äºº' || unit === 'å…ƒ') {
                                    return formatNumber(value) + unit;
                                }
                                return value + unit;
                            }
                        }
                    }
                },
                elements: {
                    point: {
                        radius: 2,
                        hoverRadius: 4
                    }
                }
            };
        }

        // æ›´æ–°Bç«¯æŒ‡æ ‡
        function updateB2BMetrics() {
            console.log('æ›´æ–°Bç«¯æŒ‡æ ‡...');
            const container = document.getElementById('b2bMetrics');
            if (!container) return;
            
            if (b2bData.length === 0) {
                container.innerHTML = '<p>æš‚æ— Bç«¯æ•°æ®</p>';
                return;
            }
            
            // æ ¹æ®å½“å‰é€‰æ‹©çš„å‘¨åº¦æŸ¥æ‰¾å¯¹åº”çš„Bç«¯æ•°æ®
            let currentB2BData = null;
            if (currentWeek) {
                const currentWeekData = weeklyData.find(item => 
                    item.å¹´ä»½ === currentWeek.year && item.å‘¨æ•° === currentWeek.week
                );
                
                if (currentWeekData) {
                    // æ ¹æ®æ—¥æœŸèŒƒå›´æŸ¥æ‰¾å¯¹åº”çš„Bç«¯æ•°æ®
                    currentB2BData = b2bData.find(item => 
                        item.èµ·å§‹æ—¥æœŸ === currentWeekData.èµ·å§‹æ—¥æœŸ && 
                        item.ç»“å°¾æ—¥æœŸ === currentWeekData.ç»“å°¾æ—¥æœŸ
                    );
                }
            }
            
            // å¦‚æœæ²¡æ‰¾åˆ°å¯¹åº”æ•°æ®ï¼Œä½¿ç”¨æœ€æ–°æ•°æ®
            const dataToShow = currentB2BData || b2bData[b2bData.length - 1];
            
            const metrics = [
                { label: 'ç­¾çº¦é‡‘é¢', value: dataToShow.ç­¾çº¦é‡‘é¢ },
                { label: 'å¼€ç¥¨é‡‘é¢', value: dataToShow.å¼€ç¥¨é‡‘é¢ },
                { label: 'å›æ¬¾é‡‘é¢', value: dataToShow.å›æ¬¾é‡‘é¢ },
                { label: 'è®¢å•æ•°', value: dataToShow.è®¢å•æ•° },
                { label: 'æ–°ç­¾', value: dataToShow.æ–°ç­¾ },
                { label: 'ç»­ç­¾', value: dataToShow.ç»­ç­¾ }
            ];
            
            container.innerHTML = metrics.map(metric => `
                <div class="b2b-metric-card">
                    <div class="b2b-metric-label">${metric.label}</div>
                    <div class="b2b-metric-value">${metric.value}</div>
                </div>
            `).join('');
        }

        // ç”ŸæˆAIåˆ†æï¼ˆè°ƒç”¨DeepSeek APIï¼‰
        async function generateAIAnalysis() {
            console.log('ç”ŸæˆAIåˆ†æ...');
            if (!currentWeek) return;
            
            const analysisElement = document.getElementById('aiAnalysis');
            if (!analysisElement) return;
            
            const currentData = weeklyData.find(item => 
                item.å¹´ä»½ === currentWeek.year && item.å‘¨æ•° === currentWeek.week
            );
            
            const lastWeekData = weeklyData.find(item => 
                item.å¹´ä»½ === currentWeek.year && item.å‘¨æ•° === currentWeek.week - 1
            );
            
            const lastYearData = weeklyData.find(item => 
                item.å¹´ä»½ === currentWeek.year - 1 && item.å‘¨æ•° === currentWeek.week
            );
            
            if (!currentData) {
                analysisElement.innerHTML = '<div class="loading">æš‚æ— æ•°æ®åˆ†æ</div>';
                return;
            }
            
            // è®¡ç®—å…³é”®å˜åŒ–æŒ‡æ ‡
            const metrics = calculateKeyMetrics(currentData, lastWeekData, lastYearData);
            
            // æš‚æ—¶ç›´æ¥ä½¿ç”¨æœ¬åœ°åˆ†æè¿›è¡Œæµ‹è¯•
            console.log('ç›´æ¥ä½¿ç”¨æœ¬åœ°åˆ†æè¿›è¡Œæµ‹è¯•');
            try {
                const fallbackAnalysis = generateOptimizedFallbackAnalysis(currentData, lastWeekData, lastYearData, metrics);
                analysisElement.innerHTML = fallbackAnalysis;
                return; // æš‚æ—¶è·³è¿‡APIè°ƒç”¨
            } catch (fallbackError) {
                console.error('æœ¬åœ°åˆ†æå¤±è´¥:', fallbackError);
                analysisElement.innerHTML = `
                    <div class="ai-column">
                        <div class="analysis-section">
                            <h5>åˆ†æå‡ºé”™</h5>
                            <div class="analysis-content">
                                <div class="analysis-text">
                                    æœ¬åœ°åˆ†æå‡ºç°é”™è¯¯: ${fallbackError.message}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // è·å–æ•™è‚²åœºæ™¯ä¿¡æ¯
            const weekInfo = getWeekScenarioInfo(currentWeek);
            
            // æ„å»ºé’ˆå¯¹å­¦ç”Ÿäº§å“çš„åˆ†ææç¤ºè¯
            const prompt = `ä½ æ˜¯æ•™è‚²è¡Œä¸šèµ„æ·±æ•°æ®åˆ†æå¸ˆï¼Œè¯·åŸºäºä»¥ä¸‹å­¦ç”Ÿäº§å“çš„å‘¨åº¦æ•°æ®è¿›è¡Œä¸“ä¸šåˆ†æï¼š

ã€äº§å“èƒŒæ™¯ã€‘å­¦ç”Ÿå­¦ä¹ äº§å“ï¼Œç”¨æˆ·ä¸»è¦ä¸ºåœ¨æ ¡å­¦ç”Ÿ
ã€æ—¶é—´åœºæ™¯ã€‘${currentWeek.year}å¹´ç¬¬${currentWeek.week}å‘¨ï¼ˆ${weekInfo.description}ï¼‰

ã€å½“å‰æ•°æ®ã€‘${currentWeek.year}å¹´ç¬¬${currentWeek.week}å‘¨ï¼š
â€¢ æ´»è·ƒç”¨æˆ·ï¼š${formatNumber(currentData.æ´»è·ƒç”¨æˆ·)}äºº
â€¢ è¥æ”¶ï¼š${formatNumber(currentData.è¥æ”¶)}å…ƒ  
â€¢ ARPUï¼š${currentData.ARPU}å…ƒ
â€¢ æ¬¡å‘¨ç•™å­˜ç‡ï¼š${currentData.æ¬¡å‘¨ç•™å­˜ç‡}%
â€¢ ä½¿ç”¨ç‡ï¼š${currentData.ä½¿ç”¨ç‡}%
â€¢ æ·±åº¦è®¿é—®ç‡ï¼š${currentData.æ·±åº¦è®¿é—®ç‡}%
â€¢ å¤§ä¼šå‘˜æ´»è·ƒç‡ï¼š${currentData.å¤§ä¼šå‘˜æ´»è·ƒç‡}%

${lastWeekData ? `ã€ç¯æ¯”å˜åŒ–ã€‘vsä¸Šå‘¨ï¼š
â€¢ æ´»è·ƒç”¨æˆ·ï¼š${metrics.userWoW}
â€¢ è¥æ”¶ï¼š${metrics.revenueWoW}
â€¢ ARPUï¼š${metrics.arpuWoW}
â€¢ ç•™å­˜ç‡ï¼š${metrics.retentionWoW}
â€¢ ä½¿ç”¨ç‡ï¼š${metrics.usageWoW}` : 'ã€è¯´æ˜ã€‘é¦–å‘¨æ•°æ®ï¼Œæ— ç¯æ¯”å¯¹æ¯”'}

${lastYearData ? `ã€åŒæ¯”å˜åŒ–ã€‘vså»å¹´åŒæœŸï¼š
â€¢ æ´»è·ƒç”¨æˆ·ï¼š${metrics.userYoY}
â€¢ è¥æ”¶ï¼š${metrics.revenueYoY}` : ''}

ã€åˆ†æè¦æ±‚ã€‘è¯·æŒ‰ç…§ä»¥ä¸‹3ä¸ªç»´åº¦åˆ†æï¼Œæ¯ä¸ªç»´åº¦2-3ä¸ªè¦ç‚¹ï¼š

1. ã€ç”¨æˆ·ç»´åº¦ã€‘åˆ†ææ´»è·ƒç”¨æˆ·å’Œç•™å­˜ç‡å˜åŒ–ï¼Œç»“åˆå­¦ä¹ åœºæ™¯åˆ¤æ–­åŸå› 
2. ã€æ”¶å…¥ç»´åº¦ã€‘åˆ†æè¥æ”¶å’ŒARPUå˜åŒ–ï¼ŒåŒºåˆ†ç”¨æˆ·è§„æ¨¡vsä»˜è´¹æ„æ„¿çš„å½±å“
3. ã€ä½¿ç”¨ç»´åº¦ã€‘åˆ†æä½¿ç”¨ç‡å’Œå¤§ä¼šå‘˜æ´»è·ƒç‡ï¼Œç»“åˆå­¦ä¹ åŠ¨æœºå’Œåœºæ™¯éœ€æ±‚

ã€æ•™è‚²åœºæ™¯åˆ†æè¦ç‚¹ã€‘
- ç”¨æˆ·å˜åŒ–éœ€è€ƒè™‘å­¦æœŸã€è€ƒè¯•ã€å‡æœŸç­‰æ•™è‚²å‘¨æœŸå› ç´ 
- æ”¶å…¥åˆ†æè¦æ˜ç¡®æ˜¯ç”¨æˆ·è§„æ¨¡è¿˜æ˜¯ä»˜è´¹æ„æ„¿é©±åŠ¨çš„å˜åŒ–
- ä½¿ç”¨ç‡å˜åŒ–è¦ç»“åˆå­¦ç”Ÿçš„å­¦ä¹ åŠ¨æœºå’Œå®é™…å­¦ä¹ åœºæ™¯
- æ¯ä¸ªç»´åº¦çš„ç­–ç•¥å»ºè®®è¦å…·ä½“å¯æ‰§è¡Œï¼Œç¬¦åˆå­¦ç”Ÿç”¨æˆ·ç‰¹ç‚¹
- è¯­è¨€ç®€æ´ä¸“ä¸šï¼Œæ¯ä¸ªè¦ç‚¹æ ‡æ³¨ç»´åº¦æ ‡ç­¾å¦‚ã€ç”¨æˆ·ã€‘ã€æ”¶å…¥ã€‘ã€ä½¿ç”¨ã€‘`;

            try {
                console.log('å¼€å§‹è°ƒç”¨DeepSeek API...');
                
                // è°ƒç”¨DeepSeek API
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer sk-22da5c080db84c23b4a5c8c54e922763',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯æ•™è‚²è¡Œä¸šèµ„æ·±æ•°æ®åˆ†æå¸ˆï¼Œæ·±åº¦ç†è§£å­¦ç”Ÿç”¨æˆ·è¡Œä¸ºå’Œæ•™è‚²äº§å“ç‰¹ç‚¹ã€‚æ“…é•¿ç»“åˆå­¦ä¹ åœºæ™¯åˆ†ææ•°æ®å˜åŒ–ï¼Œæå‡ºç¬¦åˆæ•™è‚²è§„å¾‹çš„è¿è¥ç­–ç•¥ã€‚å›ç­”è¦ç®€æ´ç²¾å‡†ï¼Œé€»è¾‘ä¸€è‡´ã€‚'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.2,  // è¿›ä¸€æ­¥é™ä½éšæœºæ€§
                        max_tokens: 1000,
                        stream: false
                    })
                });
                
                console.log('APIå“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIé”™è¯¯å“åº”:', errorText);
                    throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('APIå“åº”æˆåŠŸ');
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    const analysis = data.choices[0].message.content;
                    console.log('AIåˆ†æç»“æœ:', analysis);
                    
                    // æ ¼å¼åŒ–AIåˆ†æç»“æœ
                    const formattedAnalysis = formatAIAnalysisOptimized(analysis, currentData, metrics);
                    analysisElement.innerHTML = formattedAnalysis;
                } else {
                    throw new Error('APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸');
                }
                
            } catch (error) {
                console.error('DeepSeek APIè°ƒç”¨å¤±è´¥:', error);
                
                // ç›´æ¥åˆ‡æ¢åˆ°æœ¬åœ°åˆ†æï¼Œä¸æ˜¾ç¤ºä¸­é—´çŠ¶æ€
                console.log('åˆ‡æ¢åˆ°æœ¬åœ°åˆ†æ');
                try {
                    const fallbackAnalysis = generateOptimizedFallbackAnalysis(currentData, lastWeekData, lastYearData, metrics);
                    analysisElement.innerHTML = fallbackAnalysis;
                } catch (fallbackError) {
                    console.error('æœ¬åœ°åˆ†æä¹Ÿå¤±è´¥äº†:', fallbackError);
                    analysisElement.innerHTML = `
                        <div class="ai-column">
                            <div class="analysis-section">
                                <h5>åˆ†ææš‚ä¸å¯ç”¨</h5>
                                <div class="analysis-content">
                                    <div class="analysis-text">
                                        ç³»ç»Ÿæ­£åœ¨ç»´æŠ¤ä¸­ï¼Œè¯·ç¨åå†è¯•ã€‚
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // è®¡ç®—å…³é”®æŒ‡æ ‡å˜åŒ–
        function calculateKeyMetrics(current, lastWeek, lastYear) {
            const metrics = {};
            
            if (lastWeek) {
                // ç¯æ¯”è®¡ç®—
                metrics.userWoW = calculateChange(current.æ´»è·ƒç”¨æˆ·, lastWeek.æ´»è·ƒç”¨æˆ·, 'number');
                metrics.revenueWoW = calculateChange(current.è¥æ”¶, lastWeek.è¥æ”¶, 'number');
                metrics.arpuWoW = calculateChange(current.ARPU, lastWeek.ARPU, 'number');
                metrics.retentionWoW = calculateChange(current.æ¬¡å‘¨ç•™å­˜ç‡, lastWeek.æ¬¡å‘¨ç•™å­˜ç‡, 'percent');
                metrics.usageWoW = calculateChange(current.ä½¿ç”¨ç‡, lastWeek.ä½¿ç”¨ç‡, 'percent');
                
                // è®¡ç®—æ•°å€¼å˜åŒ–
                metrics.userWoWNum = ((current.æ´»è·ƒç”¨æˆ· - lastWeek.æ´»è·ƒç”¨æˆ·) / lastWeek.æ´»è·ƒç”¨æˆ· * 100).toFixed(1);
                metrics.revenueWoWNum = ((current.è¥æ”¶ - lastWeek.è¥æ”¶) / lastWeek.è¥æ”¶ * 100).toFixed(1);
            }
            
            if (lastYear) {
                // åŒæ¯”è®¡ç®—
                metrics.userYoY = calculateChange(current.æ´»è·ƒç”¨æˆ·, lastYear.æ´»è·ƒç”¨æˆ·, 'number');
                metrics.revenueYoY = calculateChange(current.è¥æ”¶, lastYear.è¥æ”¶, 'number');
                metrics.arpuYoY = calculateChange(current.ARPU, lastYear.ARPU, 'number');
                metrics.retentionYoY = calculateChange(current.æ¬¡å‘¨ç•™å­˜ç‡, lastYear.æ¬¡å‘¨ç•™å­˜ç‡, 'percent');
                metrics.usageYoY = calculateChange(current.ä½¿ç”¨ç‡, lastYear.ä½¿ç”¨ç‡, 'percent');
            }
            
            return metrics;
        }

        // ä¼˜åŒ–çš„AIåˆ†æç»“æœæ ¼å¼åŒ– - æ–°è®¾è®¡é£æ ¼
        function formatAIAnalysisOptimized(analysis, currentData, metrics) {
            try {
                // æ™ºèƒ½è§£æAIå›å¤
                let sections = [];
                
                // å°è¯•æŒ‰æ•°å­—æ ‡é¢˜åˆ†å‰²
                if (analysis.includes('1.') || analysis.includes('1ã€')) {
                    sections = analysis.split(/[1-3][\.\ã€]\s*/).filter(s => s.trim());
                } else if (analysis.includes('æ ¸å¿ƒå˜åŒ–') || analysis.includes('è¶‹åŠ¿åˆ¤æ–­') || analysis.includes('è¡ŒåŠ¨å»ºè®®')) {
                    // æŒ‰å…³é”®è¯åˆ†å‰²
                    const parts = analysis.split(/(?=æ ¸å¿ƒå˜åŒ–|è¶‹åŠ¿åˆ¤æ–­|è¡ŒåŠ¨å»ºè®®)/);
                    sections = parts.filter(s => s.trim());
                } else {
                    // æŒ‰æ®µè½åˆ†å‰²
                    sections = analysis.split('\n\n').filter(s => s.trim());
                }

                const sectionTitles = ['æ ¸å¿ƒè¡¨ç°', 'å…³é”®å˜åŒ–', 'ç­–ç•¥å»ºè®®'];
                let columns = ['', '', ''];
                
                // ç¬¬ä¸€åˆ—ï¼šæ ¸å¿ƒè¡¨ç°
                columns[0] = `
                    <div class="analysis-section">
                        <h5>${sectionTitles[0]}</h5>
                        <div class="analysis-content">
                            <div class="key-metrics-display">
                                <div class="metric-display">
                                    <div class="label">æ´»è·ƒç”¨æˆ·</div>
                                    <div class="value">${formatNumber(currentData.æ´»è·ƒç”¨æˆ·)}</div>
                                </div>
                                <div class="metric-display">
                                    <div class="label">è¥æ”¶</div>
                                    <div class="value">${formatNumber(currentData.è¥æ”¶)}</div>
                                </div>
                            </div>
                            <div class="analysis-text">
                                æœˆæ´»ç”¨æˆ·ä¸è¥æ”¶è¡¨ç°ç¨³å®šï¼ŒARPUä¸º${currentData.ARPU}å…ƒï¼Œç•™å­˜ç‡${currentData.æ¬¡å‘¨ç•™å­˜ç‡}%ï¼Œä½¿ç”¨ç‡${currentData.ä½¿ç”¨ç‡}%ã€‚
                            </div>
                        </div>
                    </div>
                `;

                // å¤„ç†AIåˆ†æçš„å…¶ä»–éƒ¨åˆ†
                sections.slice(0, 2).forEach((section, index) => {
                    // æ¸…ç†å†…å®¹
                    const cleanLines = section
                        .replace(/^[ï¼š:]\s*/, '')
                        .replace(/æ ¸å¿ƒå˜åŒ–[ï¼š:]?|è¶‹åŠ¿åˆ¤æ–­[ï¼š:]?|è¡ŒåŠ¨å»ºè®®[ï¼š:]?/g, '')
                        .split('\n')
                        .map(line => line.replace(/^[-â€¢Â·*]\s*/, '').trim())
                        .filter(line => line.length > 3 && line.length < 60)
                        .slice(0, 4);

                    if (cleanLines.length > 0) {
                        const columnIndex = index + 1;
                        if (columnIndex < 3) {
                            columns[columnIndex] = `
                                <div class="analysis-section">
                                    <h5>${sectionTitles[columnIndex]}</h5>
                                    <div class="analysis-content">
                                        <ul class="analysis-list">
                                            ${cleanLines.map(line => `<li>${line}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            `;
                        }
                    }
                });

                // å¦‚æœæŸåˆ—ä¸ºç©ºï¼Œæ·»åŠ é»˜è®¤å†…å®¹
                if (!columns[1].includes('analysis-section')) {
                    columns[1] = `
                        <div class="analysis-section">
                            <h5>å…³é”®å˜åŒ–</h5>
                            <div class="analysis-content">
                                <div class="analysis-text">
                                    å„é¡¹æ ¸å¿ƒæŒ‡æ ‡ä¿æŒç¨³å®šï¼Œç”¨æˆ·æ´»è·ƒåº¦è‰¯å¥½ï¼Œè¥æ”¶è¡¨ç°å¹³ç¨³ï¼Œæ•´ä½“ä¸šåŠ¡è¿è¡Œå¥åº·ã€‚
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (!columns[2].includes('analysis-section')) {
                    columns[2] = `
                        <div class="analysis-section">
                            <h5>ç­–ç•¥å»ºè®®</h5>
                            <div class="analysis-content">
                                <ul class="analysis-list">
                                    <li>æŒç»­ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ</li>
                                    <li>å…³æ³¨æ ¸å¿ƒæŒ‡æ ‡å˜åŒ–</li>
                                    <li>æ¢ç´¢æ–°çš„å¢é•¿æœºä¼š</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }

                // ç”Ÿæˆä¸‰åˆ—å¸ƒå±€
                return `
                    <div class="ai-column">${columns[0]}</div>
                    <div class="ai-column">${columns[1]}</div>
                    <div class="ai-column">${columns[2]}</div>
                `;

            } catch (error) {
                console.error('AIåˆ†ææ ¼å¼åŒ–å¤±è´¥:', error);
                // é™çº§å¤„ç†
                return `
                    <div class="ai-column">
                        <div class="analysis-section">
                            <h5>æ ¸å¿ƒè¡¨ç°</h5>
                            <div class="analysis-content">
                                <div class="key-metrics-display">
                                    <div class="metric-display">
                                        <div class="label">æ´»è·ƒç”¨æˆ·</div>
                                        <div class="value">${formatNumber(currentData.æ´»è·ƒç”¨æˆ·)}</div>
                                    </div>
                                    <div class="metric-display">
                                        <div class="label">è¥æ”¶</div>
                                        <div class="value">${formatNumber(currentData.è¥æ”¶)}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="ai-column">
                        <div class="analysis-section">
                            <h5>AIåˆ†æ</h5>
                            <div class="analysis-content">
                                <div class="analysis-text">
                                    ${analysis.substring(0, 150)}...
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="ai-column">
                        <div class="analysis-section">
                            <h5>å»ºè®®</h5>
                            <div class="analysis-content">
                                <ul class="analysis-list">
                                    <li>æŒç»­ä¼˜åŒ–äº§å“åŠŸèƒ½</li>
                                    <li>å…³æ³¨ç”¨æˆ·åé¦ˆ</li>
                                    <li>å®šæœŸæ•°æ®å¤ç›˜</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // ä¼˜åŒ–çš„æœ¬åœ°åˆ†æ - é’ˆå¯¹å­¦ç”Ÿäº§å“çš„æ•™è‚²åœºæ™¯åˆ†æ
        function generateOptimizedFallbackAnalysis(currentData, lastWeekData, lastYearData, metrics) {
            // è·å–å½“å‰å‘¨åº¦çš„æ—¶é—´ä¿¡æ¯ï¼Œç”¨äºåˆ¤æ–­å­¦ä¹ åœºæ™¯
            const weekInfo = getWeekScenarioInfo(currentWeek);
            
            // ç”Ÿæˆæ ¸å¿ƒè¡¨ç°æè¿°
            const performanceText = `å‘¨æ´»è·ƒç”¨æˆ·${formatNumber(currentData.æ´»è·ƒç”¨æˆ·)}ï¼Œè¥æ”¶${formatNumber(currentData.è¥æ”¶)}å…ƒã€‚ARPUä¸º${currentData.ARPU}å…ƒï¼Œç•™å­˜ç‡${currentData.æ¬¡å‘¨ç•™å­˜ç‡}%ï¼Œä½¿ç”¨ç‡${currentData.ä½¿ç”¨ç‡}%ã€‚`;
            
            // åŸºäºæ•™è‚²åœºæ™¯çš„å…³é”®å˜åŒ–åˆ†æ
            const keyChanges = analyzeEducationScenarioChanges(currentData, lastWeekData, metrics, weekInfo);
            
            // åŸºäºæ•™è‚²åœºæ™¯çš„ç­–ç•¥å»ºè®®
            const strategies = generateEducationStrategies(currentData, lastWeekData, metrics, weekInfo);

            // ä¸‰åˆ—å¸ƒå±€
            return `
                <div class="ai-column">
                    <div class="analysis-section">
                        <h5>æ ¸å¿ƒè¡¨ç°</h5>
                        <div class="analysis-content">
                            <div class="key-metrics-display">
                                <div class="metric-display">
                                    <div class="label">æ´»è·ƒç”¨æˆ·</div>
                                    <div class="value">${formatNumber(currentData.æ´»è·ƒç”¨æˆ·)}</div>
                                </div>
                                <div class="metric-display">
                                    <div class="label">è¥æ”¶</div>
                                    <div class="value">${formatNumber(currentData.è¥æ”¶)}</div>
                                </div>
                            </div>
                            <div class="analysis-text">
                                ${performanceText}${weekInfo.description}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ai-column">
                    <div class="analysis-section">
                        <h5>å…³é”®å˜åŒ–</h5>
                        <div class="analysis-content">
                            <ul class="analysis-list">
                                ${keyChanges.slice(0, 4).map(change => `<li>${change}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="ai-column">
                    <div class="analysis-section">
                        <h5>ç­–ç•¥å»ºè®®</h5>
                        <div class="analysis-content">
                            <ul class="analysis-list">
                                ${strategies.slice(0, 4).map(strategy => `<li>${strategy}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        // è·å–å‘¨åº¦çš„å­¦ä¹ åœºæ™¯ä¿¡æ¯
        function getWeekScenarioInfo(currentWeek) {
            if (!currentWeek) return { scenario: 'normal', description: '' };
            
            const { year, week } = currentWeek;
            
            // 2026å¹´æ˜¥èŠ‚æ˜¯2æœˆ17æ—¥ï¼ˆæ­£æœˆåˆä¸€ï¼‰ï¼Œå‡æœŸçº¦2æœˆ16æ—¥-22æ—¥
            if (year === 2026 && week === 5) {
                return {
                    scenario: 'winter_holiday',
                    description: 'å½“å‘¨ä¸ºå¯’å‡æœŸé—´ï¼ˆ1æœˆ29æ—¥-2æœˆ4æ—¥ï¼‰ï¼Œå­¦ç”Ÿå­¦ä¹ éœ€æ±‚ç›¸å¯¹è¾ƒä½ã€‚',
                    isHoliday: true
                };
            }
            
            if (year === 2026 && week === 6) {
                return {
                    scenario: 'winter_holiday_late',
                    description: 'å½“å‘¨ä¸ºå¯’å‡åæœŸï¼ˆ2æœˆ5æ—¥-11æ—¥ï¼‰ï¼Œä¸´è¿‘æ˜¥èŠ‚å‡æœŸã€‚',
                    isHoliday: true
                };
            }
            
            if (year === 2026 && week === 7) {
                return {
                    scenario: 'spring_festival',
                    description: 'å½“å‘¨åŒ…å«æ˜¥èŠ‚å‡æœŸï¼ˆ2æœˆ17æ—¥æ­£æœˆåˆä¸€ï¼‰ï¼Œå­¦ç”Ÿå¤„äºæ˜¥èŠ‚å‡æœŸçŠ¶æ€ã€‚',
                    isHoliday: true,
                    isFestival: true
                };
            }
            
            if (year === 2026 && week === 8) {
                return {
                    scenario: 'post_spring_festival',
                    description: 'å½“å‘¨ä¸ºæ˜¥èŠ‚å‡æœŸåï¼ˆ2æœˆ19æ—¥-25æ—¥ï¼‰ï¼Œå‡æœŸç»“æŸå­¦ç”Ÿé€æ­¥æ¢å¤å­¦ä¹ ã€‚',
                    isHoliday: false,
                    isPostFestival: true
                };
            }
            
            // 2026å¹´1æœˆ22æ—¥-28æ—¥æ˜¯ç¬¬4å‘¨ï¼Œä¸´è¿‘å¯’å‡
            if (year === 2026 && week === 4) {
                return {
                    scenario: 'before_winter_holiday',
                    description: 'å½“å‘¨ä¸´è¿‘å¯’å‡ï¼ŒæœŸæœ«è€ƒè¯•ç»“æŸå­¦ä¹ å¼ºåº¦ä¸‹é™ã€‚',
                    isExamPeriod: false
                };
            }
            
            // 2026å¹´1æœˆ15æ—¥-21æ—¥æ˜¯ç¬¬3å‘¨ï¼ŒæœŸæœ«è€ƒè¯•é«˜å³°æœŸ
            if (year === 2026 && week === 3) {
                return {
                    scenario: 'exam_peak',
                    description: 'å½“å‘¨ä¸ºæœŸæœ«è€ƒè¯•é«˜å³°æœŸï¼Œå­¦ä¹ éœ€æ±‚æ—ºç››ã€‚',
                    isExamPeriod: true
                };
            }
            
            // 2025å¹´åŒæœŸä½œä¸ºå¯¹æ¯”
            if (year === 2025 && week === 5) {
                return {
                    scenario: 'winter_holiday_last_year',
                    description: 'å»å¹´åŒæœŸå¯’å‡ï¼Œå¯ä½œä¸ºå‡æœŸè¡¨ç°åŸºå‡†ã€‚',
                    isHoliday: true
                };
            }
            
            if (year === 2025 && week === 6) {
                return {
                    scenario: 'winter_holiday_late_last_year',
                    description: 'å»å¹´åŒæœŸå¯’å‡åæœŸã€‚',
                    isHoliday: true
                };
            }
            
            if (year === 2025 && week === 7) {
                return {
                    scenario: 'spring_festival_last_year',
                    description: 'å»å¹´åŒæœŸæ˜¥èŠ‚å‡æœŸå‘¨ã€‚',
                    isHoliday: true,
                    isFestival: true
                };
            }
            
            if (year === 2025 && week === 8) {
                return {
                    scenario: 'post_spring_festival_last_year',
                    description: 'å»å¹´åŒæœŸæ˜¥èŠ‚å‡æœŸåã€‚',
                    isHoliday: false,
                    isPostFestival: true
                };
            }
            
            return {
                scenario: 'normal',
                description: 'æ­£å¸¸å­¦ä¹ å‘¨æœŸã€‚',
                isNormal: true
            };
        }

        // åŸºäºæ•™è‚²åœºæ™¯çš„å…³é”®å˜åŒ–åˆ†æ - æŒ‰ç”¨æˆ·ã€æ”¶å…¥ã€ä½¿ç”¨ä¸‰ä¸ªç»´åº¦
        function analyzeEducationScenarioChanges(currentData, lastWeekData, metrics, weekInfo) {
            const changes = [];
            
            if (!lastWeekData) {
                changes.push('é¦–å‘¨æ•°æ®ï¼Œæš‚æ— ç¯æ¯”å¯¹æ¯”');
                changes.push(`${weekInfo.description}`);
                return changes;
            }
            
            const userChangeNum = parseFloat(metrics.userWoWNum || 0);
            const revenueChangeNum = parseFloat(metrics.revenueWoWNum || 0);
            const usageChange = currentData.ä½¿ç”¨ç‡ - lastWeekData.ä½¿ç”¨ç‡;
            const retentionChange = currentData.æ¬¡å‘¨ç•™å­˜ç‡ - lastWeekData.æ¬¡å‘¨ç•™å­˜ç‡;
            
            // 1. ç”¨æˆ·ç»´åº¦åˆ†æ
            if (Math.abs(userChangeNum) >= 3) {
                if (weekInfo.isHoliday) {
                    if (userChangeNum < 0) {
                        changes.push(`ã€ç”¨æˆ·ã€‘å¯’å‡æœŸé—´ä¸‹é™${Math.abs(userChangeNum).toFixed(1)}%ï¼Œç¬¦åˆå‡æœŸè§„å¾‹`);
                    } else {
                        changes.push(`ã€ç”¨æˆ·ã€‘å¯’å‡æœŸé—´ä»å¢é•¿${userChangeNum.toFixed(1)}%ï¼Œè¡¨ç°è¶…é¢„æœŸ`);
                    }
                } else if (weekInfo.isExamPeriod) {
                    if (userChangeNum > 0) {
                        changes.push(`ã€ç”¨æˆ·ã€‘è€ƒè¯•æœŸå¢é•¿${userChangeNum.toFixed(1)}%ï¼Œå­¦ä¹ éœ€æ±‚æ—ºç››`);
                    } else {
                        changes.push(`ã€ç”¨æˆ·ã€‘è€ƒè¯•æœŸä¸‹é™${Math.abs(userChangeNum).toFixed(1)}%ï¼Œéœ€å…³æ³¨äº§å“åŒ¹é…åº¦`);
                    }
                } else {
                    changes.push(`ã€ç”¨æˆ·ã€‘${userChangeNum > 0 ? 'å¢é•¿' : 'ä¸‹é™'}${Math.abs(userChangeNum).toFixed(1)}%`);
                }
            }
            
            // ç”¨æˆ·ç•™å­˜åˆ†æ
            if (Math.abs(retentionChange) >= 2) {
                changes.push(`ã€ç”¨æˆ·ã€‘ç•™å­˜ç‡${retentionChange > 0 ? 'æå‡' : 'ä¸‹é™'}${Math.abs(retentionChange).toFixed(1)}ppï¼Œ${retentionChange > 0 ? 'ç”¨æˆ·ç²˜æ€§å¢å¼º' : 'æµå¤±é£é™©ä¸Šå‡'}`);
            }
            
            // 2. æ”¶å…¥ç»´åº¦åˆ†æ
            if (Math.abs(revenueChangeNum) >= 5) {
                const arpuChangeNum = lastWeekData ? ((currentData.ARPU - lastWeekData.ARPU) / lastWeekData.ARPU * 100) : 0;
                
                if (Math.abs(arpuChangeNum) >= 5) {
                    // ARPUå˜åŒ–æ˜¾è‘—ï¼Œä¸»è¦å—ä»˜è´¹æ„æ„¿å½±å“
                    changes.push(`ã€æ”¶å…¥ã€‘è¥æ”¶${revenueChangeNum > 0 ? 'å¢é•¿' : 'ä¸‹é™'}${Math.abs(revenueChangeNum).toFixed(1)}%ï¼Œä¸»è¦å—ä»˜è´¹æ„æ„¿${arpuChangeNum > 0 ? 'æå‡' : 'ä¸‹é™'}é©±åŠ¨`);
                } else {
                    // ä¸»è¦å—ç”¨æˆ·è§„æ¨¡å½±å“
                    changes.push(`ã€æ”¶å…¥ã€‘è¥æ”¶${revenueChangeNum > 0 ? 'å¢é•¿' : 'ä¸‹é™'}${Math.abs(revenueChangeNum).toFixed(1)}%ï¼Œä¸»è¦å—ç”¨æˆ·è§„æ¨¡å˜åŒ–å½±å“`);
                }
            }
            
            // 3. ä½¿ç”¨ç»´åº¦åˆ†æ
            if (Math.abs(usageChange) >= 2) {
                if (weekInfo.isHoliday && usageChange < 0) {
                    changes.push(`ã€ä½¿ç”¨ã€‘å‡æœŸä½¿ç”¨ç‡ä¸‹é™${Math.abs(usageChange).toFixed(1)}ppï¼Œå­¦ä¹ åŠ¨æœºå‡å¼±`);
                } else if (weekInfo.isExamPeriod && usageChange > 0) {
                    changes.push(`ã€ä½¿ç”¨ã€‘è€ƒè¯•æœŸä½¿ç”¨ç‡æå‡${usageChange.toFixed(1)}ppï¼Œå­¦ä¹ å¼ºåº¦å¢åŠ `);
                } else {
                    changes.push(`ã€ä½¿ç”¨ã€‘ä½¿ç”¨ç‡${usageChange > 0 ? 'æå‡' : 'ä¸‹é™'}${Math.abs(usageChange).toFixed(1)}pp`);
                }
            }
            
            // å¤§ä¼šå‘˜æ´»è·ƒç‡åˆ†æ
            const vipChange = lastWeekData ? currentData.å¤§ä¼šå‘˜æ´»è·ƒç‡ - lastWeekData.å¤§ä¼šå‘˜æ´»è·ƒç‡ : 0;
            if (Math.abs(vipChange) >= 2) {
                changes.push(`ã€ä½¿ç”¨ã€‘å¤§ä¼šå‘˜æ´»è·ƒç‡${vipChange > 0 ? 'æå‡' : 'ä¸‹é™'}${Math.abs(vipChange).toFixed(1)}pp`);
            }
            
            if (changes.length === 0) {
                changes.push('ã€ç”¨æˆ·ã€‘æ´»è·ƒåº¦ä¿æŒç¨³å®š');
                changes.push('ã€æ”¶å…¥ã€‘è¥æ”¶æ°´å¹³å¹³ç¨³');
                changes.push('ã€ä½¿ç”¨ã€‘ä½¿ç”¨æƒ…å†µè‰¯å¥½');
            }
            
            return changes;
        }

        // åŸºäºæ•™è‚²åœºæ™¯çš„ç­–ç•¥å»ºè®® - æŒ‰ç”¨æˆ·ã€æ”¶å…¥ã€ä½¿ç”¨ä¸‰ä¸ªç»´åº¦
        function generateEducationStrategies(currentData, lastWeekData, metrics, weekInfo) {
            const strategies = [];
            
            if (!lastWeekData) {
                strategies.push('ã€ç”¨æˆ·ã€‘å»ºç«‹ç”¨æˆ·è¡Œä¸ºåŸºå‡†æ•°æ®');
                strategies.push('ã€æ”¶å…¥ã€‘å®Œå–„ä»˜è´¹è½¬åŒ–åˆ†æä½“ç³»');
                strategies.push('ã€ä½¿ç”¨ã€‘ä¼˜åŒ–æ ¸å¿ƒå­¦ä¹ åŠŸèƒ½ä½“éªŒ');
                return strategies;
            }
            
            const userChangeNum = parseFloat(metrics.userWoWNum || 0);
            const revenueChangeNum = parseFloat(metrics.revenueWoWNum || 0);
            const usageChange = currentData.ä½¿ç”¨ç‡ - lastWeekData.ä½¿ç”¨ç‡;
            
            // 1. ç”¨æˆ·ç»´åº¦ç­–ç•¥
            if (weekInfo.isHoliday) {
                // å¯’å‡æœŸé—´çš„ç”¨æˆ·ç­–ç•¥
                if (userChangeNum < -10) {
                    strategies.push('ã€ç”¨æˆ·ã€‘æ¨å‡ºå‡æœŸå­¦ä¹ è®¡åˆ’ï¼Œç»´æŒç”¨æˆ·æ´»è·ƒåº¦');
                } else if (userChangeNum > 0) {
                    strategies.push('ã€ç”¨æˆ·ã€‘å‡æœŸè¡¨ç°è¶…é¢„æœŸï¼ŒåŠ å¼ºç”¨æˆ·ç•™å­˜æœºåˆ¶');
                }
            } else if (weekInfo.isExamPeriod) {
                // è€ƒè¯•æœŸé—´çš„ç”¨æˆ·ç­–ç•¥
                if (userChangeNum > 5) {
                    strategies.push('ã€ç”¨æˆ·ã€‘è€ƒè¯•æœŸéœ€æ±‚æ—ºç››ï¼Œæ‰©å¤§è·å®¢æŠ•å…¥');
                } else if (userChangeNum < 0) {
                    strategies.push('ã€ç”¨æˆ·ã€‘ä¼˜åŒ–è€ƒè¯•ç›¸å…³åŠŸèƒ½ï¼Œæå‡äº§å“åŒ¹é…åº¦');
                }
            } else {
                // æ­£å¸¸æœŸé—´çš„ç”¨æˆ·ç­–ç•¥
                if (userChangeNum < -5) {
                    strategies.push('ã€ç”¨æˆ·ã€‘åˆ†æç”¨æˆ·æµå¤±åŸå› ï¼Œä¼˜åŒ–ç•™å­˜ç­–ç•¥');
                } else if (currentData.æ¬¡å‘¨ç•™å­˜ç‡ < 40) {
                    strategies.push('ã€ç”¨æˆ·ã€‘å¼ºåŒ–æ–°ç”¨æˆ·å¼•å¯¼ï¼Œæå‡ç•™å­˜è‡³45%+');
                }
            }
            
            // 2. æ”¶å…¥ç»´åº¦ç­–ç•¥
            const arpuChangeNum = lastWeekData ? ((currentData.ARPU - lastWeekData.ARPU) / lastWeekData.ARPU * 100) : 0;
            
            if (revenueChangeNum < -10) {
                if (Math.abs(arpuChangeNum) >= 5) {
                    strategies.push('ã€æ”¶å…¥ã€‘ä»˜è´¹æ„æ„¿ä¸‹é™ï¼Œä¼˜åŒ–ä»˜è´¹äº§å“ä»·å€¼æ„ŸçŸ¥');
                } else {
                    strategies.push('ã€æ”¶å…¥ã€‘ç”¨æˆ·è§„æ¨¡å½±å“è¥æ”¶ï¼ŒåŠ å¼ºç”¨æˆ·è·å–');
                }
            } else if (currentData.ARPU < 2.0) {
                if (weekInfo.isExamPeriod) {
                    strategies.push('ã€æ”¶å…¥ã€‘è€ƒè¯•æœŸæ¨å‡ºå†²åˆºè¯¾ç¨‹ï¼Œæå‡ä»˜è´¹è½¬åŒ–');
                } else {
                    strategies.push('ã€æ”¶å…¥ã€‘æ¨å‡ºå­¦ä¹ æ•ˆæœæå‡æœåŠ¡ï¼Œæé«˜ARPU');
                }
            } else if (currentData.ARPU >= 2.5) {
                strategies.push('ã€æ”¶å…¥ã€‘ARPUè¡¨ç°ä¼˜ç§€ï¼Œæ¢ç´¢é«˜ä»·å€¼æœåŠ¡åŒ…');
            }
            
            // 3. ä½¿ç”¨ç»´åº¦ç­–ç•¥
            if (weekInfo.isHoliday && usageChange < -3) {
                strategies.push('ã€ä½¿ç”¨ã€‘è®¾è®¡å‡æœŸä¸“å±å­¦ä¹ å†…å®¹ï¼Œæå‡ä½¿ç”¨åŠ¨æœº');
            } else if (currentData.ä½¿ç”¨ç‡ < 65) {
                strategies.push('ã€ä½¿ç”¨ã€‘åˆ†æä½æ´»è·ƒç”¨æˆ·è¡Œä¸ºï¼Œä¼˜åŒ–æ ¸å¿ƒåŠŸèƒ½');
            } else if (currentData.ä½¿ç”¨ç‡ >= 75) {
                strategies.push('ã€ä½¿ç”¨ã€‘é«˜ä½¿ç”¨ç‡ä¼˜åŠ¿æ˜æ˜¾ï¼Œé‡ç‚¹è½¬åŒ–ä»˜è´¹ç”¨æˆ·');
            }
            
            // å¤§ä¼šå‘˜ç›¸å…³ç­–ç•¥
            if (currentData.å¤§ä¼šå‘˜æ´»è·ƒç‡ < 50) {
                strategies.push('ã€ä½¿ç”¨ã€‘æ¨å‡ºä¼šå‘˜ä¸“å±å­¦ä¹ èµ„æºï¼Œæå‡ä¼šå‘˜ä»·å€¼');
            }
            
            // ç¡®ä¿æ¯ä¸ªç»´åº¦éƒ½æœ‰ç­–ç•¥
            const userStrategies = strategies.filter(s => s.includes('ã€ç”¨æˆ·ã€‘'));
            const revenueStrategies = strategies.filter(s => s.includes('ã€æ”¶å…¥ã€‘'));
            const usageStrategies = strategies.filter(s => s.includes('ã€ä½¿ç”¨ã€‘'));
            
            if (userStrategies.length === 0) {
                strategies.push('ã€ç”¨æˆ·ã€‘æŒç»­ä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼Œæå‡æ»¡æ„åº¦');
            }
            if (revenueStrategies.length === 0) {
                strategies.push('ã€æ”¶å…¥ã€‘æ¢ç´¢æ–°çš„ä»˜è´¹å¢é•¿ç‚¹');
            }
            if (usageStrategies.length === 0) {
                strategies.push('ã€ä½¿ç”¨ã€‘ç»´æŒè‰¯å¥½ä½¿ç”¨ä¹ æƒ¯ï¼Œæ·±åŒ–å­¦ä¹ åœºæ™¯');
            }
            
            return strategies.slice(0, 6); // æœ€å¤š6ä¸ªå»ºè®®ï¼Œæ¯ä¸ªç»´åº¦2ä¸ª
        }

        // ==================== AIåŠ©æ‰‹åŠŸèƒ½ ====================
        
        // åˆå§‹åŒ–AIåŠ©æ‰‹
        function setupAIAssistant() {
            const aiBtn = document.getElementById('aiAssistantBtn');
            const aiModal = document.getElementById('aiChatModal');
            const aiClose = document.getElementById('aiChatClose');
            const aiInput = document.getElementById('aiChatInput');
            const aiSend = document.getElementById('aiChatSend');
            
            // ç‚¹å‡»å°æ©™å­æŒ‰é’®æ˜¾ç¤ºå¯¹è¯æ¡†
            aiBtn.addEventListener('click', () => {
                aiModal.classList.add('show');
                aiInput.focus();
            });
            
            // å…³é—­å¯¹è¯æ¡†
            aiClose.addEventListener('click', () => {
                aiModal.classList.remove('show');
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            aiModal.addEventListener('click', (e) => {
                if (e.target === aiModal) {
                    aiModal.classList.remove('show');
                }
            });
            
            // å‘é€æ¶ˆæ¯
            aiSend.addEventListener('click', sendAIMessage);
            aiInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendAIMessage();
                }
            });
            
            // å¿«æ·é—®é¢˜æŒ‰é’®
            document.querySelectorAll('.suggestion-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const question = btn.dataset.question;
                    aiInput.value = question;
                    sendAIMessage();
                });
            });
        }
        
        // å‘é€AIæ¶ˆæ¯
        async function sendAIMessage() {
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
            addMessageToChat('user', message);
            
            // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥
            showTypingIndicator();
            
            try {
                // è°ƒç”¨AI API
                const aiResponse = await callAIAssistant(message);
                
                // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
                removeTypingIndicator();
                
                // æ·»åŠ AIå›å¤åˆ°ç•Œé¢
                addMessageToChat('ai', aiResponse);
                
            } catch (error) {
                console.error('AIåŠ©æ‰‹è°ƒç”¨å¤±è´¥:', error);
                removeTypingIndicator();
                addMessageToChat('ai', 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æœ‰ç‚¹å¿™ï¼Œè¯·ç¨åå†è¯•ã€‚æ‚¨ä¹Ÿå¯ä»¥æŸ¥çœ‹å³ä¸‹è§’çš„AIæ•°æ®åˆ†æé¢æ¿è·å–åˆ†æç»“æœã€‚');
            }
        }
        
        // è°ƒç”¨AIåŠ©æ‰‹API
        async function callAIAssistant(userMessage) {
            // æ„å»ºä¸Šä¸‹æ–‡ä¿¡æ¯
            const contextInfo = buildDataContext();
            
            const prompt = `ä½ æ˜¯å°æ©™å­ğŸŠï¼Œä¸€ä¸ªä¸“ä¸šçš„æ•™è‚²æ•°æ®åˆ†æAIåŠ©æ‰‹ã€‚è¯·åŸºäºä»¥ä¸‹æ•°æ®å›ç­”ç”¨æˆ·é—®é¢˜ï¼š

ã€å½“å‰æ•°æ®èƒŒæ™¯ã€‘
${contextInfo}

ã€ç”¨æˆ·é—®é¢˜ã€‘
${userMessage}

ã€å›ç­”è¦æ±‚ã€‘
1. ä»¥å°æ©™å­çš„èº«ä»½å›ç­”ï¼Œè¯­æ°”å‹å¥½ä¸“ä¸š
2. åŸºäºå®é™…æ•°æ®è¿›è¡Œåˆ†æï¼Œç»™å‡ºå…·ä½“æ•°å­—
3. ç»“åˆæ•™è‚²åœºæ™¯ï¼ˆè€ƒè¯•ã€å‡æœŸç­‰ï¼‰åˆ†æåŸå› 
4. æä¾›å¯æ‰§è¡Œçš„å»ºè®®
5. å›ç­”ç®€æ´æ˜äº†ï¼Œæ§åˆ¶åœ¨200å­—ä»¥å†…
6. å¯ä»¥é€‚å½“ä½¿ç”¨emojiè®©å›ç­”æ›´ç”ŸåŠ¨`;

            const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer sk-22da5c080db84c23b4a5c8c54e922763',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    model: 'deepseek-chat',
                    messages: [
                        {
                            role: 'system',
                            content: 'ä½ æ˜¯å°æ©™å­ğŸŠï¼Œä¸€ä¸ªä¸“ä¸šå‹å¥½çš„æ•™è‚²æ•°æ®åˆ†æAIåŠ©æ‰‹ã€‚ä½ æ“…é•¿åˆ†æå­¦ç”Ÿäº§å“æ•°æ®ï¼Œç†è§£æ•™è‚²åœºæ™¯ï¼Œæä¾›å®ç”¨çš„è¿è¥å»ºè®®ã€‚å›ç­”è¦ç®€æ´ä¸“ä¸šï¼Œè¯­æ°”äº²åˆ‡ã€‚'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    temperature: 0.7,
                    max_tokens: 800,
                    stream: false
                })
            });
            
            if (!response.ok) {
                throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.choices && data.choices[0] && data.choices[0].message) {
                return data.choices[0].message.content;
            } else {
                throw new Error('APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸');
            }
        }
        
        // æ„å»ºæ•°æ®ä¸Šä¸‹æ–‡
        function buildDataContext() {
            if (!currentWeek) return 'æš‚æ— é€‰æ‹©çš„å‘¨åº¦æ•°æ®';
            
            const currentData = weeklyData.find(item => 
                item.å¹´ä»½ === currentWeek.year && item.å‘¨æ•° === currentWeek.week
            );
            
            const lastWeekData = weeklyData.find(item => 
                item.å¹´ä»½ === currentWeek.year && item.å‘¨æ•° === currentWeek.week - 1
            );
            
            const lastYearData = weeklyData.find(item => 
                item.å¹´ä»½ === currentWeek.year - 1 && item.å‘¨æ•° === currentWeek.week
            );
            
            if (!currentData) return 'å½“å‰å‘¨åº¦æš‚æ— æ•°æ®';
            
            let context = `å½“å‰é€‰æ‹©ï¼š${currentWeek.year}å¹´ç¬¬${currentWeek.week}å‘¨
â€¢ æ´»è·ƒç”¨æˆ·ï¼š${formatNumber(currentData.æ´»è·ƒç”¨æˆ·)}äºº
â€¢ è¥æ”¶ï¼š${formatNumber(currentData.è¥æ”¶)}å…ƒ
â€¢ ARPUï¼š${currentData.ARPU}å…ƒ
â€¢ æ¬¡å‘¨ç•™å­˜ç‡ï¼š${currentData.æ¬¡å‘¨ç•™å­˜ç‡}%
â€¢ ä½¿ç”¨ç‡ï¼š${currentData.ä½¿ç”¨ç‡}%
â€¢ å¤§ä¼šå‘˜æ´»è·ƒç‡ï¼š${currentData.å¤§ä¼šå‘˜æ´»è·ƒç‡}%`;
            
            if (lastWeekData) {
                const userChange = ((currentData.æ´»è·ƒç”¨æˆ· - lastWeekData.æ´»è·ƒç”¨æˆ·) / lastWeekData.æ´»è·ƒç”¨æˆ· * 100).toFixed(1);
                const revenueChange = ((currentData.è¥æ”¶ - lastWeekData.è¥æ”¶) / lastWeekData.è¥æ”¶ * 100).toFixed(1);
                context += `

ã€ç¯æ¯”å˜åŒ–ã€‘
â€¢ æ´»è·ƒç”¨æˆ·ï¼š${userChange > 0 ? '+' : ''}${userChange}%
â€¢ è¥æ”¶ï¼š${revenueChange > 0 ? '+' : ''}${revenueChange}%`;
            }
            
            if (lastYearData) {
                const userYoY = ((currentData.æ´»è·ƒç”¨æˆ· - lastYearData.æ´»è·ƒç”¨æˆ·) / lastYearData.æ´»è·ƒç”¨æˆ· * 100).toFixed(1);
                const revenueYoY = ((currentData.è¥æ”¶ - lastYearData.è¥æ”¶) / lastYearData.è¥æ”¶ * 100).toFixed(1);
                context += `

ã€åŒæ¯”å˜åŒ–ã€‘
â€¢ æ´»è·ƒç”¨æˆ·ï¼š${userYoY > 0 ? '+' : ''}${userYoY}%
â€¢ è¥æ”¶ï¼š${revenueYoY > 0 ? '+' : ''}${revenueYoY}%`;
            }
            
            // æ·»åŠ åœºæ™¯ä¿¡æ¯
            const weekInfo = getWeekScenarioInfo(currentWeek);
            context += `

ã€åœºæ™¯ä¿¡æ¯ã€‘${weekInfo.description}`;
            
            return context;
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessageToChat(sender, message) {
            const messagesContainer = document.getElementById('aiChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${sender}`;
            
            const currentTime = new Date().toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="user-message-avatar">æˆ‘</div>
                    <div class="ai-message-content">
                        <div class="ai-message-bubble">${message}</div>
                        <div class="ai-message-time">${currentTime}</div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="ai-message-avatar">
                        <img src="å°æ©™å­.png" alt="å°æ©™å­">
                    </div>
                    <div class="ai-message-content">
                        <div class="ai-message-bubble">${message}</div>
                        <div class="ai-message-time">${currentTime}</div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('aiChatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'ai-message typing';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="ai-message-avatar">
                    <img src="å°æ©™å­.png" alt="å°æ©™å­">
                </div>
                <div class="ai-message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
    </script>
</body>
</html>
            // æ·±åº¦åˆ†ææ ¸å¿ƒå˜åŒ–
            const coreChanges = [];
            let hasSignificantChange = false;
            
            if (lastWeekData) {
                const userChangeNum = parseFloat(metrics.userWoWNum);
                const revenueChangeNum = parseFloat(metrics.revenueWoWNum);
                const retentionChange = currentData.æ¬¡å‘¨ç•™å­˜ç‡ - lastWeekData.æ¬¡å‘¨ç•™å­˜ç‡;
                const arpuChange = currentData.ARPU - lastWeekData.ARPU;
                
                // ç”¨æˆ·å˜åŒ–åˆ†æï¼ˆæ˜¾è‘—å˜åŒ–â‰¥5%ï¼‰
                if (Math.abs(userChangeNum) >= 5) {
                    hasSignificantChange = true;
                    if (userChangeNum > 0) {
                        coreChanges.push(`ç”¨æˆ·å¢é•¿${userChangeNum.toFixed(1)}%ï¼Œè¡¨ç°ä¼˜ç§€`);
                    } else {
                        coreChanges.push(`ç”¨æˆ·ä¸‹é™${Math.abs(userChangeNum).toFixed(1)}%ï¼Œéœ€å…³æ³¨`);
                    }
                }
                
                // è¥æ”¶å˜åŒ–åˆ†æï¼ˆæ˜¾è‘—å˜åŒ–â‰¥10%ï¼‰
                if (Math.abs(revenueChangeNum) >= 10) {
                    hasSignificantChange = true;
                    if (revenueChangeNum > 0) {
                        coreChanges.push(`è¥æ”¶å¢é•¿${revenueChangeNum.toFixed(1)}%ï¼ŒåŠ¿å¤´è‰¯å¥½`);
                    } else {
                        coreChanges.push(`è¥æ”¶ä¸‹æ»‘${Math.abs(revenueChangeNum).toFixed(1)}%ï¼Œéœ€ä¼˜åŒ–`);
                    }
                }
                
                // ç•™å­˜ç‡å˜åŒ–åˆ†æï¼ˆæ˜¾è‘—å˜åŒ–â‰¥2ppï¼‰
                if (Math.abs(retentionChange) >= 2) {
                    hasSignificantChange = true;
                    if (retentionChange > 0) {
                        coreChanges.push(`ç•™å­˜ç‡æå‡${retentionChange.toFixed(1)}ppï¼Œç”¨æˆ·ç²˜æ€§å¢å¼º`);
                    } else {
                        coreChanges.push(`ç•™å­˜ç‡ä¸‹é™${Math.abs(retentionChange).toFixed(1)}ppï¼Œéœ€è­¦æƒ•`);
                    }
                }
                
                // ARPUå˜åŒ–åˆ†æï¼ˆæ˜¾è‘—å˜åŒ–â‰¥0.2å…ƒï¼‰
                if (Math.abs(arpuChange) >= 0.2) {
                    hasSignificantChange = true;
                    if (arpuChange > 0) {
                        coreChanges.push(`ARPUæå‡${arpuChange.toFixed(2)}å…ƒï¼Œå˜ç°æ”¹å–„`);
                    } else {
                        coreChanges.push(`ARPUä¸‹é™${Math.abs(arpuChange).toFixed(2)}å…ƒï¼Œéœ€å…³æ³¨`);
                    }
                }
            }
            
            // å¦‚æœæ²¡æœ‰æ˜¾è‘—å˜åŒ–ï¼Œåˆ†æå½“å‰ç»å¯¹æ°´å¹³
            if (!hasSignificantChange) {
                if (currentData.ä½¿ç”¨ç‡ >= 75) {
                    coreChanges.push(`ä½¿ç”¨ç‡${currentData.ä½¿ç”¨ç‡}%ä¿æŒé«˜ä½`);
                } else if (currentData.ä½¿ç”¨ç‡ < 60) {
                    coreChanges.push(`ä½¿ç”¨ç‡${currentData.ä½¿ç”¨ç‡}%åä½`);
                }
                
                if (currentData.æ¬¡å‘¨ç•™å­˜ç‡ >= 45) {
                    coreChanges.push(`ç•™å­˜ç‡${currentData.æ¬¡å‘¨ç•™å­˜ç‡}%è¡¨ç°è‰¯å¥½`);
                } else if (currentData.æ¬¡å‘¨ç•™å­˜ç‡ < 40) {
                    coreChanges.push(`ç•™å­˜ç‡${currentData.æ¬¡å‘¨ç•™å­˜ç‡}%éœ€æå‡`);
                }
                
                if (currentData.å¤§ä¼šå‘˜æ´»è·ƒç‡ >= 55) {
                    coreChanges.push(`ä¼šå‘˜æ´»è·ƒç‡${currentData.å¤§ä¼šå‘˜æ´»è·ƒç‡}%è¡¨ç°ä¼˜ç§€`);
                } else if (currentData.å¤§ä¼šå‘˜æ´»è·ƒç‡ <= 45) {
                    coreChanges.push(`ä¼šå‘˜æ´»è·ƒç‡${currentData.å¤§ä¼šå‘˜æ´»è·ƒç‡}%æœ‰å¾…æå‡`);
                }
                
                if (coreChanges.length === 0) {
                    coreChanges.push('å„é¡¹æŒ‡æ ‡å˜åŒ–å¹³ç¨³');
                    coreChanges.push('æ•´ä½“ä¸šåŠ¡è¿è¡Œç¨³å®š');
                }
            }

            // æ™ºèƒ½è¶‹åŠ¿åˆ¤æ–­
            const trends = [];
            if (lastWeekData) {
                const userGrowth = parseFloat(metrics.userWoWNum);
                const revenueGrowth = parseFloat(metrics.revenueWoWNum);
                const retentionChange = currentData.æ¬¡å‘¨ç•™å­˜ç‡ - lastWeekData.æ¬¡å‘¨ç•™å­˜ç‡;
                
                // ç”¨æˆ·ä¸è¥æ”¶å…³è”åˆ†æ
                if (userGrowth > 3 && revenueGrowth > 5) {
                    trends.push(`ç”¨æˆ·è¥æ”¶åŒå¢é•¿ï¼Œä¸šåŠ¡å¥åº·å‘ä¸Š`);
                } else if (userGrowth > 0 && revenueGrowth < -5) {
                    trends.push(`ç”¨æˆ·å¢${userGrowth.toFixed(1)}%è¥æ”¶é™${Math.abs(revenueGrowth).toFixed(1)}%ï¼Œå˜ç°å¾…ä¼˜åŒ–`);
                } else if (userGrowth < -3 && revenueGrowth > 0) {
                    trends.push(`ç”¨æˆ·é™${Math.abs(userGrowth).toFixed(1)}%è¥æ”¶å‡${revenueGrowth.toFixed(1)}%ï¼ŒARPUæå‡`);
                } else if (userGrowth < -5 && revenueGrowth < -10) {
                    trends.push('ç”¨æˆ·è¥æ”¶åŒä¸‹é™ï¼Œéœ€ç´§æ€¥å…³æ³¨');
                } else {
                    trends.push('ç”¨æˆ·è¥æ”¶å˜åŒ–å¹³ç¨³');
                }
                
                // ç•™å­˜ç‡è¶‹åŠ¿åˆ†æ
                if (currentData.æ¬¡å‘¨ç•™å­˜ç‡ >= 45) {
                    if (retentionChange > 0) {
                        trends.push(`ç•™å­˜ç‡${currentData.æ¬¡å‘¨ç•™å­˜ç‡}%ä¸”ä¸Šå‡ï¼Œç”¨æˆ·ç²˜æ€§å¼º`);
                    } else {
                        trends.push(`ç•™å­˜ç‡${currentData.æ¬¡å‘¨ç•™å­˜ç‡}%å¥åº·ï¼Œç”¨æˆ·ç²˜æ€§è‰¯å¥½`);
                    }
                } else if (currentData.æ¬¡å‘¨ç•™å­˜ç‡ < 35) {
                    trends.push(`ç•™å­˜ç‡${currentData.æ¬¡å‘¨ç•™å­˜ç‡}%åä½ï¼Œæµå¤±é£é™©é«˜`);
                } else {
                    trends.push(`ç•™å­˜ç‡${currentData.æ¬¡å‘¨ç•™å­˜ç‡}%ä¸­ç­‰ï¼Œæœ‰æå‡ç©ºé—´`);
                }
                
                // ä½¿ç”¨ç‡è¶‹åŠ¿
                if (currentData.ä½¿ç”¨ç‡ >= 75) {
                    trends.push(`ä½¿ç”¨ç‡${currentData.ä½¿ç”¨ç‡}%ä¼˜ç§€ï¼Œäº§å“å¸å¼•åŠ›å¼º`);
                } else if (currentData.ä½¿ç”¨ç‡ < 60) {
                    trends.push(`ä½¿ç”¨ç‡${currentData.ä½¿ç”¨ç‡}%å¾…æå‡`);
                }
            } else {
                // é¦–å‘¨æ•°æ®åˆ†æ
                if (currentData.æ´»è·ƒç”¨æˆ· >= 100000) {
                    trends.push(`ç”¨æˆ·åŸºæ•°${formatNumber(currentData.æ´»è·ƒç”¨æˆ·)}ï¼Œå‘å±•æ½œåŠ›å¤§`);
                }
                if (currentData.æ¬¡å‘¨ç•™å­˜ç‡ >= 40) {
                    trends.push(`ç•™å­˜ç‡${currentData.æ¬¡å‘¨ç•™å­˜ç‡}%è¡¨ç°ä¸é”™`);
                }
                if (currentData.ä½¿ç”¨ç‡ >= 70) {
                    trends.push(`ä½¿ç”¨ç‡${currentData.ä½¿ç”¨ç‡}%è‰¯å¥½å¼€å±€`);
                }
            }
            
            // ç¡®ä¿è‡³å°‘æœ‰2ä¸ªè¶‹åŠ¿åˆ†æ
            if (trends.length === 0) {
                trends.push('æ•´ä½“æŒ‡æ ‡è¡¨ç°å¹³ç¨³');
                trends.push('æŒç»­è§‚å¯Ÿå…³é”®å˜åŒ–');
            } else if (trends.length === 1) {
                trends.push('å»ºè®®æŒç»­è·Ÿè¸ªæ ¸å¿ƒæŒ‡æ ‡');
            }

            // å…·ä½“å¯æ‰§è¡Œçš„è¡ŒåŠ¨å»ºè®®
            const actions = [];
            
            if (lastWeekData) {
                const userChangeNum = parseFloat(metrics.userWoWNum);
                const revenueChangeNum = parseFloat(metrics.revenueWoWNum);
                const retentionChange = currentData.æ¬¡å‘¨ç•™å­˜ç‡ - lastWeekData.æ¬¡å‘¨ç•™å­˜ç‡;
                const usageChange = currentData.ä½¿ç”¨ç‡ - lastWeekData.ä½¿ç”¨ç‡;
                
                // åŸºäºå®é™…æ•°æ®ç»™å‡ºå…·ä½“å»ºè®®
                let specificActions = [];
                
                // 1. ç”¨æˆ·å˜åŒ–åˆ†æ
                if (Math.abs(userChangeNum) >= 5) {
                    if (userChangeNum > 0) {
                        specificActions.push(`ç”¨æˆ·å¢é•¿${userChangeNum.toFixed(1)}%ï¼ŒåŠ å¤§æŠ•å…¥æ‰©å¤§è§„æ¨¡`);
                    } else {
                        specificActions.push(`ç”¨æˆ·ä¸‹é™${Math.abs(userChangeNum).toFixed(1)}%ï¼Œå¯åŠ¨å¬å›è®¡åˆ’`);
                    }
                }
                
                // 2. è¥æ”¶å˜åŒ–åˆ†æ
                if (Math.abs(revenueChangeNum) >= 5) {
                    if (revenueChangeNum > 0) {
                        specificActions.push(`è¥æ”¶å¢é•¿${revenueChangeNum.toFixed(1)}%ï¼Œä¼˜åŒ–å˜ç°ç­–ç•¥`);
                    } else {
                        specificActions.push(`è¥æ”¶ä¸‹é™${Math.abs(revenueChangeNum).toFixed(1)}%ï¼Œç´§æ€¥ä¼˜åŒ–ä»˜è´¹æµç¨‹`);
                    }
                }
                
                // 3. ç•™å­˜ç‡åˆ†æ
                if (Math.abs(retentionChange) >= 2) {
                    if (retentionChange > 0) {
                        specificActions.push(`ç•™å­˜ç‡æå‡${retentionChange.toFixed(1)}ppï¼Œç»§ç»­å¼ºåŒ–ç”¨æˆ·ä½“éªŒ`);
                    } else {
                        specificActions.push(`ç•™å­˜ç‡ä¸‹é™${Math.abs(retentionChange).toFixed(1)}ppï¼Œä¼˜åŒ–æ–°æ‰‹å¼•å¯¼`);
                    }
                } else if (currentData.æ¬¡å‘¨ç•™å­˜ç‡ < 40) {
                    specificActions.push(`ç•™å­˜ç‡${currentData.æ¬¡å‘¨ç•™å­˜ç‡}%åä½ï¼Œåˆ¶å®šæå‡è®¡åˆ’`);
                }
                
                // 4. å½“å‰çŠ¶æ€åˆ†æï¼ˆåŸºäºç»å¯¹å€¼ï¼‰
                if (currentData.å¤§ä¼šå‘˜æ´»è·ƒç‡ <= 50) {
                    specificActions.push(`æ¨å‡ºä¼šå‘˜ä¸“å±æ´»åŠ¨æå‡${currentData.å¤§ä¼šå‘˜æ´»è·ƒç‡}%æ´»è·ƒç‡`);
                }
                
                if (currentData.ARPU < 2.0) {
                    specificActions.push(`æµ‹è¯•ä»˜è´¹åŠŸèƒ½å®šä»·ï¼Œç›®æ ‡ARPUæå‡è‡³2.5å…ƒ`);
                }
                
                if (currentData.ä½¿ç”¨ç‡ < 70) {
                    specificActions.push(`åˆ†æç”¨æˆ·è¡Œä¸ºï¼Œä¼˜åŒ–${currentData.ä½¿ç”¨ç‡}%ä½¿ç”¨ç‡`);
                } else if (currentData.ä½¿ç”¨ç‡ >= 75) {
                    specificActions.push(`ç»´æŒ${currentData.ä½¿ç”¨ç‡}%é«˜ä½¿ç”¨ç‡ï¼Œæ¢ç´¢ä»˜è´¹è½¬åŒ–`);
                }
                
                // é€‰æ‹©æœ€é‡è¦çš„3ä¸ªå»ºè®®
                if (specificActions.length >= 3) {
                    actions.push(...specificActions.slice(0, 3));
                } else {
                    actions.push(...specificActions);
                    
                    // è¡¥å……é€šç”¨å»ºè®®
                    while (actions.length < 3) {
                        if (actions.length === 1) {
                            actions.push('å®šæœŸåˆ†æç”¨æˆ·è¡Œä¸ºæ•°æ®');
                        } else if (actions.length === 2) {
                            actions.push('å»ºç«‹ç«å“å¯¹æ¯”ç›‘æ§æœºåˆ¶');
                        }
                    }
                }
                
            } else {
                // é¦–å‘¨å»ºè®®
                actions.push('å»ºç«‹å®Œæ•´æ•°æ®ç›‘æ§ä½“ç³»');
                actions.push('åˆ¶å®šæ˜ç¡®ç”¨æˆ·å¢é•¿ç›®æ ‡');
                actions.push('ä¼˜åŒ–æ ¸å¿ƒè½¬åŒ–æ¼æ–—æµç¨‹');
            }

            // ä¸‰åˆ—å¸ƒå±€
            return `
                <div class="ai-column">
                    <div class="analysis-section">
                        <h5>ğŸ“Š æ ¸å¿ƒè¡¨ç°</h5>
                        <div class="key-metrics-compact">
                            <div class="metric-compact">
                                <div class="label">æ´»è·ƒç”¨æˆ·</div>
                                <div class="value">${formatNumber(currentData.æ´»è·ƒç”¨æˆ·)}</div>
                            </div>
                            <div class="metric-compact">
                                <div class="label">è¥æ”¶</div>
                                <div class="value">${formatNumber(currentData.è¥æ”¶)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="analysis-section">
                        <h5>ğŸ” æ ¸å¿ƒå˜åŒ–</h5>
                        <ul>
                            ${coreChanges.slice(0, 3).map(change => `<li>${change}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                <div class="ai-column">
                    <div class="analysis-section">
                        <h5>ğŸ“ˆ è¶‹åŠ¿åˆ¤æ–­</h5>
                        <ul>
                            ${trends.slice(0, 3).map(trend => `<li>${trend}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                <div class="ai-column">
                    <div class="analysis-section">
                        <h5>ğŸ’¡ è¡ŒåŠ¨å»ºè®®</h5>
                        <ul>
                            ${actions.slice(0, 3).map(action => `<li>${action}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
        }

        // é™çº§åˆ†æï¼ˆå½“APIè°ƒç”¨å¤±è´¥æ—¶ï¼‰
        function generateFallbackAnalysis(currentData, lastWeekData) {
            const changes = lastWeekData ? {
                userChange: ((currentData.æ´»è·ƒç”¨æˆ· - lastWeekData.æ´»è·ƒç”¨æˆ·) / lastWeekData.æ´»è·ƒç”¨æˆ· * 100).toFixed(1),
                revenueChange: ((currentData.è¥æ”¶ - lastWeekData.è¥æ”¶) / lastWeekData.è¥æ”¶ * 100).toFixed(1),
                retentionChange: (currentData.æ¬¡å‘¨ç•™å­˜ç‡ - lastWeekData.æ¬¡å‘¨ç•™å­˜ç‡).toFixed(1),
                usageChange: (currentData.ä½¿ç”¨ç‡ - lastWeekData.ä½¿ç”¨ç‡).toFixed(1)
            } : null;

            // ç”Ÿæˆæ™ºèƒ½åˆ†æ
            let keyChanges = [];
            let trends = [];
            let suggestions = [];

            if (changes) {
                // å…³é”®å˜åŒ–åˆ†æ
                if (Math.abs(changes.userChange) > 5) {
                    keyChanges.push(`æ´»è·ƒç”¨æˆ·${changes.userChange > 0 ? 'å¤§å¹…å¢é•¿' : 'æ˜¾è‘—ä¸‹é™'}${Math.abs(changes.userChange)}%`);
                }
                if (Math.abs(changes.revenueChange) > 10) {
                    keyChanges.push(`è¥æ”¶${changes.revenueChange > 0 ? 'å¼ºåŠ²å¢é•¿' : 'æ˜æ˜¾ä¸‹æ»‘'}${Math.abs(changes.revenueChange)}%`);
                }
                if (Math.abs(changes.retentionChange) > 3) {
                    keyChanges.push(`ç•™å­˜ç‡${changes.retentionChange > 0 ? 'æå‡' : 'ä¸‹é™'}${Math.abs(changes.retentionChange)}pp`);
                }

                // è¶‹åŠ¿åˆ†æ
                if (changes.userChange > 0 && changes.revenueChange > 0) {
                    trends.push('ç”¨æˆ·å¢é•¿ä¸è¥æ”¶å¢é•¿å‘ˆæ­£ç›¸å…³ï¼Œä¸šåŠ¡å‘å±•è‰¯å¥½');
                } else if (changes.userChange > 0 && changes.revenueChange < 0) {
                    trends.push('ç”¨æˆ·å¢é•¿ä½†è¥æ”¶ä¸‹é™ï¼Œéœ€å…³æ³¨å˜ç°æ•ˆç‡');
                } else if (changes.userChange < 0 && changes.revenueChange > 0) {
                    trends.push('ç”¨æˆ·å‡å°‘ä½†è¥æ”¶å¢é•¿ï¼ŒARPUæå‡æ˜æ˜¾');
                }

                if (currentData.ä½¿ç”¨ç‡ > 70) {
                    trends.push('ä½¿ç”¨ç‡ä¿æŒé«˜ä½ï¼Œç”¨æˆ·ç²˜æ€§è‰¯å¥½');
                } else if (currentData.ä½¿ç”¨ç‡ < 50) {
                    trends.push('ä½¿ç”¨ç‡åä½ï¼Œéœ€æå‡äº§å“å¸å¼•åŠ›');
                }

                // ç­–ç•¥å»ºè®®
                if (changes.userChange < -5) {
                    suggestions.push('åŠ å¼ºç”¨æˆ·è·å–å’Œå¬å›ç­–ç•¥');
                }
                if (changes.retentionChange < -2) {
                    suggestions.push('ä¼˜åŒ–æ–°ç”¨æˆ·å¼•å¯¼å’Œç•™å­˜æœºåˆ¶');
                }
                if (currentData.ARPU < 2) {
                    suggestions.push('æ¢ç´¢æå‡ARPUçš„å˜ç°æ–¹å¼');
                }
                if (currentData.å¤§ä¼šå‘˜æ´»è·ƒç‡ < 50) {
                    suggestions.push('åŠ å¼ºä¼šå‘˜æƒç›Šå’Œæ´»è·ƒåº¦è¿è¥');
                }
            } else {
                keyChanges = ['å½“å‰ä¸ºé¦–å‘¨æ•°æ®ï¼Œæš‚æ— å¯¹æ¯”åŸºå‡†'];
                trends = ['å»ºè®®å»ºç«‹æ•°æ®åŸºçº¿ï¼ŒæŒç»­è·Ÿè¸ªå…³é”®æŒ‡æ ‡'];
                suggestions = ['åˆ¶å®šæ˜ç¡®çš„å¢é•¿ç›®æ ‡å’Œç›‘æ§ä½“ç³»'];
            }

            // å¦‚æœæ²¡æœ‰æ˜¾è‘—å˜åŒ–ï¼Œæ·»åŠ é»˜è®¤å†…å®¹
            if (keyChanges.length === 0) {
                keyChanges.push('å„é¡¹æŒ‡æ ‡ç›¸å¯¹ç¨³å®šï¼Œæ— æ˜¾è‘—æ³¢åŠ¨');
            }
            if (trends.length === 0) {
                trends.push('æ•´ä½“ä¸šåŠ¡è¡¨ç°å¹³ç¨³');
            }
            if (suggestions.length === 0) {
                suggestions.push('æŒç»­ä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼Œå…³æ³¨é•¿æœŸå¢é•¿');
            }

            return `
                <div class="analysis-section">
                    <h5>ğŸ“Š æ ¸å¿ƒè¡¨ç°</h5>
                    <div class="key-metrics-compact">
                        <div class="metric-compact">
                            <div class="label">æ´»è·ƒç”¨æˆ·</div>
                            <div class="value">${formatNumber(currentData.æ´»è·ƒç”¨æˆ·)}</div>
                        </div>
                        <div class="metric-compact">
                            <div class="label">è¥æ”¶</div>
                            <div class="value">${formatNumber(currentData.è¥æ”¶)}</div>
                        </div>
                        <div class="metric-compact">
                            <div class="label">ç•™å­˜ç‡</div>
                            <div class="value">${currentData.æ¬¡å‘¨ç•™å­˜ç‡}%</div>
                        </div>
                        <div class="metric-compact">
                            <div class="label">ARPU</div>
                            <div class="value">${currentData.ARPU}</div>
                        </div>
                    </div>
                </div>
                
                <div class="analysis-section">
                    <h5>ğŸ“ˆ å…³é”®å˜åŒ–åˆ†æ</h5>
                    <ul>
                        ${keyChanges.map(change => `<li>${change}</li>`).join('')}
                    </ul>
                </div>
                
                <div class="analysis-section">
                    <h5>ğŸ“Š å¢é•¿è¶‹åŠ¿åˆ†æ</h5>
                    <ul>
                        ${trends.map(trend => `<li>${trend}</li>`).join('')}
                    </ul>
                </div>
                
                <div class="analysis-section">
                    <h5>ğŸ’¡ è¿è¥ç­–ç•¥å»ºè®®</h5>
                    <ul>
                        ${suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
    </script>
</body>
</html>